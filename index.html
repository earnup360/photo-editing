<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Thumbnail Designer</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght@400;500&family=Baloo+Da+2:wght@400;600&family=Hind+Siliguri:wght@400;600&family=Noto+Serif+Bengali:wght@400;600&family=Anek+Bangla:wght@400;600&family=Rajdhani:wght@400;600&family=Atma:wght@400;600&family=Galada:wght@400;600&family=Moulpali:wght@400;600&family=Tiro+Bengali:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">

    <style>
        /* CSS Variables for theming */
        :root {
            --primary-color: #ff5e5e; /* Vibrant Red for actions/accents */
            --secondary-color: #2c3e50; /* Dark Blue-Grey for top/bottom bars */
            --accent-color: #3498db; /* Medium Blue for buttons/hover */
            --bg-light: #f5f7fa; /* Light Grey for main background */
            --bg-dark: #dfe6e9; /* Medium Grey for canvas area */
            --text-dark: #2d3436;
            --text-light: #ffffff;
            --border-color: rgba(255, 255, 255, 0.15);
            --shadow-soft: 0 2px 10px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 5px 20px rgba(0, 0, 0, 0.2);
            --border-radius: 8px;
            --toolbar-height: 60px;
            --artboard-size: 5000px; /* Large artboard size */
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-light);
            min-height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
            color: var(--text-dark);
        }

        /* Landscape mode warning (for vertical app) */
        @media (orientation: landscape) {
            body::before {
                content: "অনুগ্রহ করে সেরা অভিজ্ঞতার জন্য আপনার ডিভাইসটি উল্লম্ব (Portrait) মোডে ঘোরান।\nPlease rotate your device to portrait mode for best experience.";
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background-color: rgba(0, 0, 0, 0.95);
                color: var(--text-light);
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 1.5em;
                z-index: 9999;
                text-align: center;
                padding: 20px;
                box-sizing: border-box;
            }
            .app-container {
                display: none !important;
            }
        }

        .app-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            background-color: var(--text-light);
            box-shadow: var(--shadow-medium);
            overflow: hidden;
            border-radius: var(--border-radius);
            margin: 5px;
        }

        /* Top Menu Bar (Save, Clear, Undo/Redo) */
        .top-menu-bar {
            height: var(--toolbar-height);
            background-color: var(--secondary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            box-shadow: var(--shadow-soft);
            z-index: 10;
        }
        .top-menu-bar button {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-light);
            font-size: 1em;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 5px;
        }
        .top-menu-bar button:hover:not([disabled]), 
        .top-menu-bar button:active:not([disabled]) {
            background-color: var(--primary-color);
            transform: translateY(-2px);
        }
        .top-menu-bar button[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.05);
        }

        /* Canvas Area */
        .canvas-area {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--bg-dark);
            position: relative;
            padding: 10px;
            overflow: hidden;
            background-image: 
                linear-gradient(45deg, #ccc 25%, transparent 25%),
                linear-gradient(-45deg, #ccc 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #ccc 75%),
                linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        .canvas-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: var(--text-light);
            border: 2px solid var(--primary-color);
            box-shadow: var(--shadow-medium);
            border-radius: var(--border-radius);
            overflow: hidden;
            touch-action: none;
            transform-origin: center center;
            transition: transform 0.1s ease-out;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* Bottom Toolbar / Option Menu */
        .bottom-toolbar {
            height: var(--toolbar-height);
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            padding: 0 15px;
            box-shadow: var(--shadow-soft);
            z-index: 10;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            white-space: nowrap;
            gap: 10px;
        }
        .bottom-toolbar::-webkit-scrollbar {
            display: none;
        }
        .bottom-toolbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .bottom-toolbar button {
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-light);
            font-size: 1.4em;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            outline: none;
            min-width: 50px;
        }
        .bottom-toolbar button:hover, 
        .bottom-toolbar button.active {
            background-color: var(--primary-color);
            transform: translateY(-2px);
        }
        .bottom-toolbar button:active {
            transform: translateY(0);
        }
        .bottom-toolbar button i {
            pointer-events: none;
        }

        /* Property Panel (Slides from bottom) */
        .property-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100vw;
            max-height: 80vh;
            background-color: var(--text-light);
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.25);
            z-index: 100;
            display: flex;
            flex-direction: column;
            padding: 20px;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            overflow-y: auto;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
        }
        .property-panel.active {
            transform: translateY(0);
        }
        .property-panel h3 {
            font-family: 'Poppins', sans-serif;
            color: var(--primary-color);
            margin: 0 0 20px 0;
            text-align: center;
            font-size: 1.4em;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .property-panel label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.9em;
        }
        .property-panel input[type="text"],
        .property-panel input[type="number"],
        .property-panel input[type="color"],
        .property-panel select,
        .property-panel input[type="range"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            font-size: 0.9em;
            background-color: var(--bg-light);
            color: var(--text-dark);
            transition: border-color 0.2s;
        }
        .property-panel input[type="text"]:focus,
        .property-panel input[type="number"]:focus,
        .property-panel input[type="color"]:focus,
        .property-panel select:focus,
        .property-panel input[type="range"]:focus {
            border-color: var(--accent-color);
            outline: none;
        }
        .property-panel .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: var(--text-dark);
            font-size: 1.5em;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .property-panel .close-btn:hover {
            background-color: var(--bg-light);
        }
        .property-group {
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 20px;
            background-color: var(--bg-light);
        }
        .property-group h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--secondary-color);
            font-size: 1.1em;
            border-bottom: 1px dashed #ccc;
            padding-bottom: 8px;
        }
        .property-group .button-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .property-group .button-row button {
            background-color: var(--accent-color);
            color: var(--text-light);
            border: none;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-grow: 1;
            transition: all 0.2s;
        }
        .property-group .button-row button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        .property-group .button-row button:active {
            transform: translateY(0);
        }
        .property-group .button-row button i {
            font-size: 1.1em;
        }
        .color-palette {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .color-box {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.2s;
        }
        .color-box:hover {
            transform: scale(1.1);
            border-color: var(--primary-color);
            box-shadow: var(--shadow-soft);
        }

        /* Modals (Image Cropper, Templates, Font, Color Pickers, Layers, Add/Edit Text) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: var(--text-light);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            padding: 25px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-content .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-dark);
            font-size: 1.5em;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .modal-content .close-btn:hover {
            background-color: var(--bg-light);
        }

        /* Image Cropper Modal specific styles */
        #imageCropperModal .modal-body {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        #imageCropperModal .image-preview-container {
            width: 100%;
            max-height: 60vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
        }
        #imageCropperModal .image-preview-container img {
            display: block;
            max-width: 100%;
            max-height: 100%;
        }
        #imageCropperModal .crop-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        #imageCropperModal .crop-controls button {
            background-color: var(--accent-color);
            color: var(--text-light);
            border: none;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        #imageCropperModal .crop-controls button:hover {
            background-color: #2980b9;
        }
        #imageCropperModal .crop-controls button.active {
            background-color: var(--primary-color);
        }
        #imageCropperModal .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        #imageCropperModal .modal-buttons button {
            flex-grow: 1;
            background-color: var(--accent-color);
            color: var(--text-light);
            border: none;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        #imageCropperModal .modal-buttons button:hover {
            background-color: #2980b9;
        }
        #imageCropperModal .modal-buttons button.cancel {
            background-color: #b0bec5;
            color: var(--text-dark);
        }
        #imageCropperModal .modal-buttons button.cancel:hover {
            background-color: #95a5a6;
        }

        /* Hidden file input */
        .hidden-file-input {
            display: none;
        }

        /* Template/Font/Color Picker Modal specific styles */
        .template-grid, .font-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .template-item, .font-item {
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-soft);
        }
        .template-item:hover, .font-item:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
            box-shadow: var(--shadow-medium);
        }
        .template-item img {
            width: 100%;
            height: auto;
            display: block;
        }
        .template-item p, .font-item p {
            background-color: #f9f9f9;
            padding: 10px;
            margin: 0;
            font-size: 0.9em;
            text-align: center;
            color: var(--text-dark);
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .font-item p {
            font-size: 1.1em;
            padding: 15px 10px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .font-item.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.3);
        }

        /* Color Picker Modal */
        #textColorPickerModal .color-options, 
        #colorOverlayModal .color-options, 
        #textGradientModal .color-options {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-top: 20px;
            justify-items: center;
        }
        #textColorPickerModal .color-option-box, 
        #colorOverlayModal .color-option-box, 
        #textGradientModal .color-option-box {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow-soft);
        }
        #textColorPickerModal .color-option-box:hover, 
        #colorOverlayModal .color-option-box:hover, 
        #textGradientModal .color-option-box:hover {
            transform: scale(1.1);
            border-color: var(--primary-color);
        }
        #textColorPickerModal input[type="color"], 
        #colorOverlayModal input[type="color"], 
        #textGradientModal input[type="color"] {
            width: 100%;
            height: 50px;
            margin-top: 20px;
            padding: 0;
            border: none;
            background: none;
            cursor: pointer;
        }

        /* Layers Panel Modal */
        #layersPanelModal .modal-content {
            max-width: 95vw;
            max-height: 80vh;
            width: 400px;
        }
        #layersPanelModal .layer-list {
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
            margin-top: 15px;
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 5px;
        }
        #layersPanelModal .layer-item {
            display: flex;
            align-items: center;
            background-color: var(--bg-light);
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow-soft);
        }
        #layersPanelModal .layer-item:hover {
            background-color: #e0e0e0;
            border-color: var(--primary-color);
        }
        #layersPanelModal .layer-item.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.3);
            background-color: #f0f0f0;
        }
        #layersPanelModal .layer-item .layer-icon {
            font-size: 1.2em;
            margin-right: 12px;
            color: var(--secondary-color);
        }
        #layersPanelModal .layer-item .layer-name {
            flex-grow: 1;
            font-weight: 600;
            color: var(--text-dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #layersPanelModal .layer-item .layer-lock-btn {
            background: none;
            border: none;
            font-size: 1.2em;
            color: var(--text-dark);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.2s;
        }
        #layersPanelModal .layer-item .layer-lock-btn:hover {
            background-color: #ccc;
        }
        #layersPanelModal .layer-item .layer-lock-btn.locked {
            color: var(--primary-color);
        }
        /* Style for partial text coloring example */
        .partial-text-example {
            font-size: 1em;
            text-align: center;
            margin-top: 15px;
            color: #555;
        }

        /* Add/Edit Text Modal */
        #addTextModal h3 {
            font-family: 'Poppins', sans-serif;
            color: var(--secondary-color);
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.4em;
        }
        #addTextModal textarea {
            width: 100%;
            height: 120px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            font-size: 1em;
            resize: vertical;
            transition: border-color 0.2s;
        }
        #addTextModal textarea:focus {
            border-color: var(--accent-color);
            outline: none;
        }
        #addTextModal .modal-buttons button {
            flex-grow: 1;
            background-color: var(--accent-color);
            color: var(--text-light);
            border: none;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        #addTextModal .modal-buttons button:hover {
            background-color: #2980b9;
        }
        #addTextModal .modal-buttons button.cancel {
            background-color: #b0bec5;
            color: var(--text-dark);
        }
        #addTextModal .modal-buttons button.cancel:hover {
            background-color: #95a5a6;
        }
        #addTextModal .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* Lock Icon next to zoom controls */
        .lock-icon-area {
            position: absolute;
            top: 15px;
            left: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background-color: rgba(44, 62, 80, 0.9);
            border-radius: var(--border-radius);
            padding: 8px;
            box-shadow: var(--shadow-soft);
            z-index: 20;
        }
        .lock-icon-area button {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.2em;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .lock-icon-area button:hover, 
        .lock-icon-area button:active {
            background-color: var(--primary-color);
            transform: scale(1.1);
        }
        .lock-icon-area button.locked {
            color: var(--primary-color);
        }

        /* Zoom controls */
        .zoom-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background-color: rgba(44, 62, 80, 0.9);
            border-radius: var(--border-radius);
            padding: 8px;
            box-shadow: var(--shadow-soft);
            z-index: 20;
        }
        .zoom-controls button {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.2em;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .zoom-controls button:hover {
            background-color: var(--primary-color);
            transform: scale(1.1);
        }
        .zoom-controls button:active {
            transform: scale(0.95);
        }

        /* Download format options */
        .download-options {
            position: absolute;
            top: 15px;
            right: 80px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background-color: rgba(44, 62, 80, 0.9);
            border-radius: var(--border-radius);
            padding: 8px;
            box-shadow: var(--shadow-soft);
            z-index: 20;
        }
        .download-options button {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1em;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .download-options button:hover {
            background-color: var(--primary-color);
            transform: translateY(-2px);
        }
        .download-options button:active {
            transform: translateY(0);
        }

        /* Desktop-specific styles */
        @media (min-width: 768px) {
            .app-container {
                margin: 15px;
            }
            .top-menu-bar {
                padding: 0 25px;
            }
            .bottom-toolbar {
                padding: 0 25px;
            }
            .property-panel {
                width: 400px;
                left: auto;
                right: 15px;
                bottom: 15px;
                border-radius: var(--border-radius);
                transform: translateY(calc(100% + 15px));
            }
            .property-panel.active {
                transform: translateY(0);
            }
            .modal-content {
                padding: 30px;
            }
            .template-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        /* Artboard grid */
        .artboard-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: var(--artboard-size);
            height: var(--artboard-size);
            background-image: 
                linear-gradient(#ccc 1px, transparent 1px),
                linear-gradient(90deg, #ccc 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: center center;
            z-index: -1;
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="top-menu-bar">
            <div>
                <button id="downloadBtn" title="Download Thumbnail"><i class="fas fa-download"></i> Download</button>
                <button id="clearCanvasBtn" title="Clear Canvas"><i class="fas fa-eraser"></i> Clear</button>
            </div>
            <div>
                <button id="undoBtn" title="Undo" disabled><i class="fas fa-undo"></i> Undo</button>
                <button id="redoBtn" title="Redo" disabled><i class="fas fa-redo"></i> Redo</button>
            </div>
        </div>

        <div class="canvas-area">
            <div class="artboard-grid"></div>
            <div class="canvas-wrapper">
                <canvas id="thumbnailCanvas"></canvas>
            </div>
            <div class="zoom-controls">
                <button id="zoomInBtn" title="Zoom In"><i class="fas fa-search-plus"></i></button>
                <button id="zoomOutBtn" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
                <button id="resetZoomBtn" title="Reset Zoom"><i class="fas fa-compress"></i></button>
            </div>
            <div class="download-options">
                <button id="downloadPngBtn" title="Download as PNG"><i class="fas fa-file-image"></i> PNG</button>
                <button id="downloadJpgBtn" title="Download as JPG"><i class="fas fa-file-image"></i> JPG</button>
                <button id="downloadSvgBtn" title="Download as SVG"><i class="fas fa-file-code"></i> SVG</button>
            </div>
            <div class="lock-icon-area">
                <button id="globalLockUnlockBtn" title="Lock/Unlock Selected"><i class="fas fa-lock"></i></button>
            </div>
        </div>

        <div class="bottom-toolbar">
            <button id="addNewTextBtn" title="Add New Text"><i class="fas fa-plus-square"></i> <span class="toolbar-label">Text</span></button>
            <button id="editTextBtn" title="Edit Text" style="display:none;"><i class="fas fa-edit"></i> <span class="toolbar-label">Edit</span></button>
            <button id="openTextColorModalBtn" title="Text Color"><i class="fas fa-palette"></i> <span class="toolbar-label">Color</span></button>
            <button id="openFontModalBtn" title="Text Font"><i class="fas fa-text-height"></i> <span class="toolbar-label">Font</span></button>
            <button id="openTextGradientModalBtn" title="Text Gradient"><i class="fas fa-fill"></i> <span class="toolbar-label">Gradient</span></button>
            <button id="addShapeBtn" title="Add Shape"><i class="fas fa-shapes"></i> <span class="toolbar-label">Shapes</span></button>
            <button id="addOverlayImageBtn" title="Add Overlay Image"><i class="fas fa-images"></i> <span class="toolbar-label">Image</span></button>
            <button id="setBgImageBtn" title="Set Background Image"><i class="fas fa-image-polaroid"></i> <span class="toolbar-label">BG Image</span></button>
            <button id="setBgColorBtn" title="Background Color"><i class="fas fa-fill-drip"></i> <span class="toolbar-label">BG Color</span></button>
            <button id="openColorAdjustmentsBtn" title="Color Adjustments"><i class="fas fa-paint-brush"></i> <span class="toolbar-label">Adjust</span></button>
            <button id="loadTemplateBtn" title="Load Template"><i class="fas fa-layer-group"></i> <span class="toolbar-label">Templates</span></button>
            <button id="canvasSizeBtn" title="Canvas Size"><i class="fas fa-expand-arrows-alt"></i> <span class="toolbar-label">Size</span></button>
            <button id="openLayersPanelBtn" title="Layers"><i class="fas fa-list-alt"></i> <span class="toolbar-label">Layers</span></button>
            <button id="deleteObjectBtn" title="Delete Selected"><i class="fas fa-trash-alt"></i> <span class="toolbar-label">Delete</span></button>
        </div>

        <div id="propertyPanel" class="property-panel">
            <button class="close-btn" onclick="hidePropertyPanel()"><i class="fas fa-times"></i></button>
            <h3>Properties</h3>

            <div class="property-group">
                <h4>Common Settings</h4>
                <div class="button-row">
                    <button id="bringForwardBtn" title="Bring Forward"><i class="fas fa-arrow-up"></i> Bring Forward</button>
                    <button id="sendBackwardBtn" title="Send Backward"><i class="fas fa-arrow-down"></i> Send Backward</button>
                </div>
            </div>

            <div id="textProperties" style="display:none;" class="property-group">
                <h4>Text Settings</h4>
                <label for="panelTextInput">Text:</label>
                <input type="text" id="panelTextInput">

                <label for="panelFontSize">Font Size:</label>
                <input type="number" id="panelFontSize" min="10">
               
                <div class="button-row">
                    <button id="boldBtn" title="Bold"><i class="fas fa-bold"></i> Bold</button>
                    <button id="italicBtn" title="Italic"><i class="fas fa-italic"></i> Italic</button>
                    <button id="underlineBtn" title="Underline"><i class="fas fa-underline"></i> Underline</button>
                </div>

                <div class="property-group">
                    <h4>Text Stroke</h4>
                    <label for="textStrokeColor">Color:</label>
                    <input type="color" id="textStrokeColor" value="#000000">
                    <label for="textStrokeWidth">Width:</label>
                    <input type="number" id="textStrokeWidth" min="0" value="0">
                </div>

                <div class="property-group">
                    <h4>Text Shadow</h4>
                    <label for="textShadowColor">Color:</label>
                    <input type="color" id="textShadowColor" value="#000000">
                    <label for="textShadowBlur">Blur:</label>
                    <input type="number" id="textShadowBlur" min="0" value="0">
                    <label for="textShadowOffsetX">Offset X:</label>
                    <input type="number" id="textShadowOffsetX" value="0">
                    <label for="textShadowOffsetY">Offset Y:</label>
                    <input type="number" id="textShadowOffsetY" value="0">
                </div>

                <div class="property-group">
                    <h4>Text Background</h4>
                    <label for="textBgColor">Color:</label>
                    <input type="color" id="textBgColor" value="#ffffff">
                    <label for="textBgOpacity">Opacity:</label>
                    <input type="range" id="textBgOpacity" min="0" max="1" step="0.01" value="0">
                    <label for="textBgRadius">Roundness:</label>
                    <input type="number" id="textBgRadius" min="0" value="0">
                </div>
            </div>

            <div id="imageProperties" style="display:none;" class="property-group">
                <h4>Image Settings</h4>
                <label for="panelOpacity">Opacity:</label>
                <input type="range" id="panelOpacity" min="0" max="1" step="0.01" value="1">
                <div class="button-row">
                    <button id="imageRecropBtn" onclick="showCropperModal(true, 're-crop')"><i class="fas fa-crop"></i> Re-crop Image</button>
                    <button id="toggleImageRoundnessBtn" onclick="toggleImageRoundness()"><i class="fas fa-circle"></i> Make Round</button>
                    <button onclick="applyColorOverlayModal()"><i class="fas fa-tint"></i> Apply Color Overlay</button>
                </div>
                <div id="colorAdjustments" class="property-group">
                    <h4>Color Adjustments</h4>
                    <label for="brightnessRange">Brightness:</label>
                    <input type="range" id="brightnessRange" min="0" max="200" value="100">
                    <label for="contrastRange">Contrast:</label>
                    <input type="range" id="contrastRange" min="0" max="200" value="100">
                    <label for="saturationRange">Saturation:</label>
                    <input type="range" id="saturationRange" min="0" max="200" value="100">
                    <label for="hueRange">Hue:</label>
                    <input type="range" id="hueRange" min="0" max="360" value="0">
                </div>
            </div>

            <div id="shapeProperties" style="display:none;" class="property-group">
                <h4>Shape Settings</h4>
                <label for="panelShapeColor">Fill Color:</label>
                <input type="color" id="panelShapeColor">
                <label for="panelShapeBorderColor">Border Color:</label>
                <input type="color" id="panelShapeBorderColor">
                <label for="panelShapeBorderWidth">Border Width:</label>
                <input type="number" id="panelShapeBorderWidth" min="0" value="0">
                <label for="panelShapeOpacity">Opacity:</label>
                <input type="range" id="panelShapeOpacity" min="0" max="1" step="0.01" value="1">
            </div>

            <div id="bgColorProperties" style="display:none;" class="property-group">
                <h4>Background Color</h4>
                <label for="panelBgColor">Select Color:</label>
                <input type="color" id="panelBgColor" value="#ffffff">
                <div class="color-palette">
                    <div class="color-box" style="background-color: #ffffff;" data-color="#ffffff"></div>
                    <div class="color-box" style="background-color: #f1c40f;" data-color="#f1c40f"></div>
                    <div class="color-box" style="background-color: #3498db;" data-color="#3498db"></div>
                    <div class="color-box" style="background-color: #2ecc71;" data-color="#2ecc71"></div>
                    <div class="color-box" style="background-color: #e74c3c;" data-color="#e74c3c"></div>
                    <div class="color-box" style="background-color: #9b59b6;" data-color="#9b59b6"></div>
                    <div class="color-box" style="background-color: #1abc9c;" data-color="#1abc9c"></div>
                    <div class="color-box" style="background-color: #e67e22;" data-color="#e67e22"></div>
                    <div class="color-box" style="background-color: #7f8c8d;" data-color="#7f8c8d"></div>
                    <div class="color-box" style="background-color: #2c3e50;" data-color="#2c3e50"></div>
                </div>
                <button onclick="removeBackground()"><i class="fas fa-times-circle"></i> Remove Background Image</button>
            </div>
            
            <div id="canvasSizeProperties" style="display:none;" class="property-group">
                <h4>Canvas Size</h4>
                <label for="canvasWidthInput">Width:</label>
                <input type="number" id="canvasWidthInput" value="5000" min="100">
                <label for="canvasHeightInput">Height:</label>
                <input type="number" id="canvasHeightInput" value="5000" min="100">
                <div class="button-row">
                    <button onclick="resizeCanvasToDefault()"><i class="fas fa-undo"></i> Reset to 5000x5000</button>
                    <button onclick="applyCanvasSize()"><i class="fas fa-check"></i> Apply Size</button>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="imageCropperModal" class="modal-overlay">
            <div class="modal-content">
                <button class="close-btn" onclick="hideModal('imageCropperModal')"><i class="fas fa-times"></i></button>
                <h3>Upload & Crop Image</h3>
                <div class="modal-body">
                    <input type="file" id="cropperImageInput" class="hidden-file-input" accept="image/*" onchange="initCropper(event)">
                    
                    <div class="image-preview-container">
                        <img id="imageToCrop" src="" alt="Image to Crop">
                    </div>

                    <div class="crop-controls">
                        <button data-aspect="1" class="crop-aspect-btn active">1:1</button>
                        <button data-aspect="1.7777777777777777" class="crop-aspect-btn">16:9</button>
                        <button data-aspect="0.5625" class="crop-aspect-btn">9:16</button>
                        <button data-aspect="NaN" class="crop-aspect-btn">Free</button>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button onclick="triggerFileInput('cropperImageInput')"><i class="fas fa-folder-open"></i> Select Image</button>
                    <button id="cropAndApplyBtn" style="display:none;"><i class="fas fa-cut"></i> Crop & Apply</button>
                    <button class="cancel" onclick="hideModal('imageCropperModal')"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </div>
        </div>

        <div id="templateModal" class="modal-overlay">
            <div class="modal-content">
                <button class="close-btn" onclick="hideModal('templateModal')"><i class="fas fa-times"></i></button>
                <h3>Choose a Template</h3>
                <div class="template-grid">
                    <div class="template-item" onclick="loadTemplate(1)">
                        <img src="https://via.placeholder.com/200x112/f1c40f/ffffff?text=বাংলা+টেমপ্লেট+১" alt="Template 1">
                        <p>বাংলা টাইটেল</p>
                    </div>
                    <div class="template-item" onclick="loadTemplate(2)">
                        <img src="https://via.placeholder.com/200x112/3498db/ffffff?text=Template+2" alt="Template 2">
                        <p>Creative Layout</p>
                    </div>
                     <div class="template-item" onclick="loadTemplate(3)">
                        <img src="https://via.placeholder.com/200x112/e74c3c/ffffff?text=Awesome+Design" alt="Template 3">
                        <p>Awesome Design</p>
                    </div>
                     <div class="template-item" onclick="loadTemplate(4)">
                        <img src="https://via.placeholder.com/200x112/2ecc71/ffffff?text=YouTube+Video" alt="Template 4">
                        <p>YouTube Video</p>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="cancel" onclick="hideModal('templateModal')"><i class="fas fa-times"></i> Close</button>
                </div>
            </div>
        </div>

        <div id="addShapeModal" class="modal-overlay">
            <div class="modal-content">
                <button class="close-btn" onclick="hideModal('addShapeModal')"><i class="fas fa-times"></i></button>
                <h3>Add Shape</h3>
                <div class="modal-buttons">
                    <button onclick="addShape('rect')"><i class="fas fa-square"></i> Rectangle</button>
                    <button onclick="addShape('circle')"><i class="fas fa-circle"></i> Circle</button>
                    <button onclick="addShape('triangle')"><i class="fas fa-caret-up"></i> Triangle</button>
                </div>
                <div class="modal-buttons">
                    <button class="cancel" onclick="hideModal('addShapeModal')"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </div>
        </div>

        <div id="fontSelectionModal" class="modal-overlay">
            <div class="modal-content">
                <button class="close-btn" onclick="hideModal('fontSelectionModal')"><i class="fas fa-times"></i></button>
                <h3>Select Font</h3>
                <div class="font-grid">
                    <div class="font-group">
                        <h4>English Fonts</h4>
                        <div class="font-list">
                            <div class="font-item" data-font="Poppins"><p style="font-family: Poppins;">Poppins</p></div>
                            <div class="font-item" data-font="Roboto"><p style="font-family: Roboto;">Roboto</p></div>
                            <div class="font-item" data-font="Open Sans"><p style="font-family: 'Open Sans';">Open Sans</p></div>
                            <div class="font-item" data-font="Montserrat"><p style="font-family: Montserrat;">Montserrat</p></div>
                            <div class="font-item" data-font="Lato"><p style="font-family: Lato;">Lato</p></div>
                            <div class="font-item" data-font="Oswald"><p style="font-family: Oswald;">Oswald</p></div>
                            <div class="font-item" data-font="Raleway"><p style="font-family: Raleway;">Raleway</p></div>
                            <div class="font-item" data-font="Merriweather"><p style="font-family: Merriweather;">Merriweather</p></div>
                            <div class="font-item" data-font="Playfair Display"><p style="font-family: 'Playfair Display';">Playfair Display</p></div>
                            <div class="font-item" data-font="Lora"><p style="font-family: Lora;">Lora</p></div>
                        </div>
                    </div>
                    <div class="font-group">
                        <h4>বাংলা ফন্ট</h4>
                        <div class="font-list">
                            <div class="font-item" data-font="Baloo Da 2"><p style="font-family: 'Baloo Da 2';">আমার ফন্ট</p></div>
                            <div class="font-item" data-font="Hind Siliguri"><p style="font-family: 'Hind Siliguri';">আমার ফন্ট</p></div>
                            <div class="font-item" data-font="Noto Serif Bengali"><p style="font-family: 'Noto Serif Bengali';">আমার ফন্ট</p></div>
                            <div class="font-item" data-font="Anek Bangla"><p style="font-family: 'Anek Bangla';">আমার ফন্ট</p></div>
                            <div class="font-item" data-font="Rajdhani"><p style="font-family: Rajdhani;">আমার ফন্ট</p></div>
                            <div class="font-item" data-font="Atma"><p style="font-family: Atma;">আমার ফন্ট</p></div>
                            <div class="font-item" data-font="Galada"><p style="font-family: Galada;">আমার ফন্ট</p></div>
                            <div class="font-item" data-font="Moulpali"><p style="font-family: Moulpali;">আমার ফন্ট</p></div>
                            <div class="font-item" data-font="Tiro Bangla"><p style="font-family: 'Tiro Bangla';">আমার ফন্ট</p></div>
                            <div class="font-item" data-font="Monda"><p style="font-family: Monda;">আমার ফন্ট</p></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="textColorPickerModal" class="modal-overlay">
            <div class="modal-content">
                <button class="close-btn" onclick="hideModal('textColorPickerModal')"><i class="fas fa-times"></i></button>
                <h3>Select Text Color</h3>
                <p class="partial-text-example">ডাবল ক্লিক করে টেক্সট এডিট মোডে যান এবং রঙ পরিবর্তন করতে টেক্সট সিলেক্ট করুন।</p>
                <input type="color" id="modalTextColorInput" value="#000000">
                <div class="color-options">
                    <div class="color-option-box" style="background-color: #000000;" data-color="#000000"></div>
                    <div class="color-option-box" style="background-color: #ffffff;" data-color="#ffffff"></div>
                    <div class="color-option-box" style="background-color: #f44336;" data-color="#f44336"></div>
                    <div class="color-option-box" style="background-color: #2196f3;" data-color="#2196f3"></div>
                    <div class="color-option-box" style="background-color: #4caf50;" data-color="#4caf50"></div>
                    <div class="color-option-box" style="background-color: #ffeb3b;" data-color="#ffeb3b"></div>
                    <div class="color-option-box" style="background-color: #ff9800;" data-color="#ff9800"></div>
                    <div class="color-option-box" style="background-color: #9c27b0;" data-color="#9c27b0"></div>
                    <div class="color-option-box" style="background-color: #607d8b;" data-color="#607d8b"></div>
                    <div class="color-option-box" style="background-color: #795548;" data-color="#795548"></div>
                </div>
                <div class="modal-buttons" style="margin-top: 20px;">
                    <button onclick="applyTextColorFromModal()"><i class="fas fa-check-circle"></i> Apply Color</button>
                    <button class="cancel" onclick="hideModal('textColorPickerModal')"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </div>
        </div>

        <div id="colorOverlayModal" class="modal-overlay">
            <div class="modal-content">
                <button class="close-btn" onclick="hideModal('colorOverlayModal')"><i class="fas fa-times"></i></button>
                <h3>Apply Color Overlay</h3>
                <label for="overlayColorInput">Overlay Color:</label>
                <input type="color" id="overlayColorInput" value="#000000">
                <label for="overlayOpacityRange">Overlay Opacity:</label>
                <input type="range" id="overlayOpacityRange" min="0" max="1" step="0.01" value="0">
                <div class="color-options">
                    <div class="color-option-box" style="background-color: #000000;" data-color="#000000"></div>
                    <div class="color-option-box" style="background-color: #ffffff;" data-color="#ffffff"></div>
                    <div class="color-option-box" style="background-color: #f44336;" data-color="#f44336"></div>
                    <div class="color-option-box" style="background-color: #2196f3;" data-color="#2196f3"></div>
                    <div class="color-option-box" style="background-color: #4caf50;" data-color="#4caf50"></div>
                    <div class="color-option-box" style="background-color: #ffeb3b;" data-color="#ffeb3b"></div>
                    <div class="color-option-box" style="background-color: #ff9800;" data-color="#ff9800"></div>
                    <div class="color-option-box" style="background-color: #9c27b0;" data-color="#9c27b0"></div>
                    <div class="color-option-box" style="background-color: #607d8b;" data-color="#607d8b"></div>
                    <div class="color-option-box" style="background-color: #795548;" data-color="#795548"></div>
                </div>
                <div class="modal-buttons" style="margin-top: 20px;">
                    <button onclick="applyColorOverlay()"><i class="fas fa-check-circle"></i> Apply Overlay</button>
                    <button class="cancel" onclick="hideModal('colorOverlayModal')"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </div>
        </div>

        <div id="layersPanelModal" class="modal-overlay">
            <div class="modal-content">
                <button class="close-btn" onclick="hideModal('layersPanelModal')"><i class="fas fa-times"></i></button>
                <h3>Layers</h3>
                <div id="layerList" class="layer-list">
                    <!-- Layers will be added here dynamically -->
                </div>
            </div>
        </div>
        
        <div id="textGradientModal" class="modal-overlay">
            <div class="modal-content">
                <button class="close-btn" onclick="hideModal('textGradientModal')"><i class="fas fa-times"></i></button>
                <h3>Apply Text Gradient</h3>
                <div class="gradient-color-pickers">
                    <label for="gradientColor1">Color 1:</label>
                    <input type="color" id="gradientColor1" value="#ff0000">
                    <label for="gradientColor2">Color 2:</label>
                    <input type="color" id="gradientColor2" value="#0000ff">
                </div>
                <div class="gradient-direction">
                    <button data-direction="0" class="gradient-direction-btn active">Horizontal</button>
                    <button data-direction="90">Vertical</button>
                    <button data-direction="45">Diagonal (down)</button>
                    <button data-direction="135">Diagonal (up)</button>
                </div>
                <div class="modal-buttons" style="margin-top: 20px;">
                    <button onclick="applyTextGradient()"><i class="fas fa-check-circle"></i> Apply Gradient</button>
                    <button class="cancel" onclick="hideModal('textGradientModal')"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </div>
        </div>

        <div id="addTextModal" class="modal-overlay">
            <div class="modal-content">
                <button class="close-btn" onclick="hideModal('addTextModal')"><i class="fas fa-times"></i></button>
                <h3>Add/Edit Text</h3>
                <textarea id="textInputArea" placeholder="Enter your text here..."></textarea>
                <div class="modal-buttons">
                    <button id="confirmAddUpdateTextBtn"><i class="fas fa-check"></i> Add Text</button>
                    <button class="cancel" onclick="hideModal('addTextModal')"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/canvg/3.0.9/canvg.min.js"></script>

    <script>
        // Initialize canvas with large artboard size (5000x5000)
        const canvas = new fabric.Canvas('thumbnailCanvas', {
            width: 5000,
            height: 5000,
            backgroundColor: '#ffffff',
            preserveObjectStacking: true
        });

        // --- Undo/Redo History ---
        let history = [];
        let historyPointer = -1;
        let isRedoing = false;

        function saveCanvasState() {
            if (isRedoing) {
                isRedoing = false;
                history = history.slice(0, historyPointer + 1);
            }
            const json = JSON.stringify(canvas.toJSON([
                'lockMovementX', 'lockMovementY', 'lockRotation', 'lockScalingX', 'lockScalingY',
                'lockSkewingX', 'lockSkewingY', 'selectable', 'evented', 'hasControls',
                'overlayColor', 'overlayOpacity', 'compositeOperation', 'clipPath',
                'stroke', 'strokeWidth', 'shadow', 'backgroundColor', 'textBackgroundColor', 'textBackgroundRadius',
                'fill'
            ]));
            history.push(json);
            historyPointer = history.length - 1;
            updateUndoRedoButtons();
        }

        function undo() {
            if (historyPointer > 0) {
                historyPointer--;
                isRedoing = true;
                canvas.loadFromJSON(history[historyPointer], function() {
                    canvas.renderAll();
                    updateUndoRedoButtons();
                    hidePropertyPanel();
                    
                    canvas.getObjects().forEach(obj => {
                        if (obj.type === 'image' && obj.filters && obj.filters.length > 0) {
                            obj.applyFilters();
                        }
                        if (obj.type === 'image' && obj.overlayColor && obj.overlayOpacity !== undefined) {
                            obj.set({
                                fill: obj.overlayColor,
                                opacity: obj.overlayOpacity,
                                compositeOperation: obj.compositeOperation || 'source-over'
                            });
                        }
                        if (obj.type === 'i-text') {
                            obj.set({
                                backgroundColor: obj.backgroundColor,
                                shadow: obj.shadow,
                                stroke: obj.stroke,
                                strokeWidth: obj.strokeWidth,
                                textBackgroundColor: obj.textBackgroundColor,
                                textBackgroundRadius: obj.textBackgroundRadius,
                                fill: obj.fill
                            });
                        }
                        obj.set({
                            selectable: obj.selectable,
                            evented: obj.evented,
                            hasControls: obj.hasControls,
                            lockMovementX: obj.lockMovementX,
                            lockMovementY: obj.lockMovementY,
                            lockRotation: obj.lockRotation,
                            lockScalingX: obj.lockScalingX,
                            lockScalingY: obj.lockScalingY,
                            lockSkewingX: obj.lockSkewingX,
                            lockSkewingY: obj.lockSkewingY
                        });
                    });
                    
                    if (canvas.backgroundImage) {
                        if (canvas.backgroundImage.filters && canvas.backgroundImage.filters.length > 0) {
                            canvas.backgroundImage.applyFilters();
                        }
                        if (canvas.backgroundImage.overlayColor && canvas.backgroundImage.overlayOpacity !== undefined) {
                            canvas.backgroundImage.set({
                                fill: canvas.backgroundImage.overlayColor,
                                opacity: canvas.backgroundImage.overlayOpacity,
                                compositeOperation: canvas.backgroundImage.compositeOperation || 'source-over'
                            });
                        }
                    }
                    
                    canvas.renderAll();
                    updateLayersPanel();
                });
            }
        }

        function redo() {
            if (historyPointer < history.length - 1) {
                historyPointer++;
                isRedoing = true;
                canvas.loadFromJSON(history[historyPointer], function() {
                    canvas.renderAll();
                    updateUndoRedoButtons();
                    hidePropertyPanel();
                    
                    canvas.getObjects().forEach(obj => {
                        if (obj.type === 'image' && obj.filters && obj.filters.length > 0) {
                            obj.applyFilters();
                        }
                        if (obj.type === 'image' && obj.overlayColor && obj.overlayOpacity !== undefined) {
                            obj.set({
                                fill: obj.overlayColor,
                                opacity: obj.overlayOpacity,
                                compositeOperation: obj.compositeOperation || 'source-over'
                            });
                        }
                        if (obj.type === 'i-text') {
                            obj.set({
                                backgroundColor: obj.backgroundColor,
                                shadow: obj.shadow,
                                stroke: obj.stroke,
                                strokeWidth: obj.strokeWidth,
                                textBackgroundColor: obj.textBackgroundColor,
                                textBackgroundRadius: obj.textBackgroundRadius,
                                fill: obj.fill
                            });
                        }
                        obj.set({
                            selectable: obj.selectable,
                            evented: obj.evented,
                            hasControls: obj.hasControls,
                            lockMovementX: obj.lockMovementX,
                            lockMovementY: obj.lockMovementY,
                            lockRotation: obj.lockRotation,
                            lockScalingX: obj.lockScalingX,
                            lockScalingY: obj.lockScalingY,
                            lockSkewingX: obj.lockSkewingX,
                            lockSkewingY: obj.lockSkewingY
                        });
                    });
                    
                    if (canvas.backgroundImage) {
                        if (canvas.backgroundImage.filters && canvas.backgroundImage.filters.length > 0) {
                            canvas.backgroundImage.applyFilters();
                        }
                        if (canvas.backgroundImage.overlayColor && canvas.backgroundImage.overlayOpacity !== undefined) {
                            canvas.backgroundImage.set({
                                fill: canvas.backgroundImage.overlayColor,
                                opacity: canvas.backgroundImage.overlayOpacity,
                                compositeOperation: canvas.backgroundImage.compositeOperation || 'source-over'
                            });
                        }
                    }
                    
                    canvas.renderAll();
                    updateLayersPanel();
                });
            }
        }

        function updateUndoRedoButtons() {
            document.getElementById('undoBtn').disabled = (historyPointer <= 0);
            document.getElementById('redoBtn').disabled = (historyPointer >= history.length - 1);
        }

        // Initialize history with initial canvas state
        saveCanvasState();
        canvas.on('object:modified', saveCanvasState);
        canvas.on('object:added', saveCanvasState);
        canvas.on('object:removed', saveCanvasState);
        canvas.on('selection:cleared', saveCanvasState);
        canvas.on('text:selection:changed', function(options) {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                if (activeObject.isEditing && activeObject.selectionStart !== activeObject.selectionEnd) {
                    const selectedStyles = activeObject.getSelectionStyles();
                    const firstColor = selectedStyles[0]?.fill;
                    const allSameColor = selectedStyles.every(style => style.fill === firstColor);
                    document.getElementById('modalTextColorInput').value = allSameColor ? firstColor : '#000000';
                } else {
                    document.getElementById('modalTextColorInput').value = activeObject.fill;
                }
            }
        });

        // --- UI Control & Modal Functions ---
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            if (modalId === 'imageCropperModal') {
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                document.getElementById('imageToCrop').src = "";
                document.getElementById('cropAndApplyBtn').style.display = 'none';
            }
        }

        function showPropertyPanel(type) {
            document.getElementById('propertyPanel').classList.add('active');
            document.getElementById('textProperties').style.display = 'none';
            document.getElementById('imageProperties').style.display = 'none';
            document.getElementById('shapeProperties').style.display = 'none';
            document.getElementById('bgColorProperties').style.display = 'none';
            document.getElementById('canvasSizeProperties').style.display = 'none';
            
            const activeObject = canvas.getActiveObject();

            if (type === 'text') {
                document.getElementById('textProperties').style.display = 'block';
                if (activeObject && activeObject.type === 'i-text') {
                    document.getElementById('panelTextInput').value = activeObject.text;
                    document.getElementById('panelFontSize').value = activeObject.fontSize;
                    document.getElementById('boldBtn').classList.toggle('active', activeObject.fontWeight === 'bold');
                    document.getElementById('italicBtn').classList.toggle('active', activeObject.fontStyle === 'italic');
                    document.getElementById('underlineBtn').classList.toggle('active', activeObject.underline);
                    
                    document.getElementById('textStrokeColor').value = activeObject.stroke || '#000000';
                    document.getElementById('textStrokeWidth').value = activeObject.strokeWidth || 0;

                    const shadow = activeObject.shadow || {color: '#000000', blur: 0, offsetX: 0, offsetY: 0};
                    document.getElementById('textShadowColor').value = shadow.color;
                    document.getElementById('textShadowBlur').value = shadow.blur;
                    document.getElementById('textShadowOffsetX').value = shadow.offsetX;
                    document.getElementById('textShadowOffsetY').value = shadow.offsetY;

                    document.getElementById('textBgColor').value = activeObject.backgroundColor || '#ffffff';
                    document.getElementById('textBgOpacity').value = activeObject.backgroundColor ? (new fabric.Color(activeObject.backgroundColor).getAlpha()) : 0;
                    document.getElementById('textBgRadius').value = activeObject.textBackgroundRadius || 0;
                }
            } else if (type === 'image') {
                document.getElementById('imageProperties').style.display = 'block';
                document.getElementById('colorAdjustments').style.display = 'block';
                if (activeObject && activeObject.type === 'image') {
                    document.getElementById('panelOpacity').value = activeObject.opacity;
                    const filters = activeObject.filters || [];
                    document.getElementById('brightnessRange').value = filters[0] && filters[0].type === 'Brightness' ? (filters[0].brightness * 100) + 100 : 100;
                    document.getElementById('contrastRange').value = filters[1] && filters[1].type === 'Contrast' ? (filters[1].contrast * 100) + 100 : 100;
                    document.getElementById('saturationRange').value = filters[2] && filters[2].type === 'Saturation' ? (filters[2].saturation * 100) + 100 : 100;
                    document.getElementById('hueRange').value = filters[3] && filters[3].type === 'HueRotation' ? (filters[3].rotation * 360 / (2 * Math.PI)) : 0;
                }
            } else if (type === 'shape') {
                document.getElementById('shapeProperties').style.display = 'block';
                if (activeObject && (activeObject.type === 'rect' || activeObject.type === 'circle' || activeObject.type === 'triangle')) {
                    document.getElementById('panelShapeColor').value = activeObject.fill;
                    document.getElementById('panelShapeBorderColor').value = activeObject.stroke || '#000000';
                    document.getElementById('panelShapeBorderWidth').value = activeObject.strokeWidth || 0;
                    document.getElementById('panelShapeOpacity').value = activeObject.opacity;
                }
            } else if (type === 'background_color') {
                document.getElementById('bgColorProperties').style.display = 'block';
                document.getElementById('panelBgColor').value = canvas.backgroundColor || '#ffffff';
            } else if (type === 'canvas_size') {
                document.getElementById('canvasSizeProperties').style.display = 'block';
                document.getElementById('canvasWidthInput').value = canvas.width;
                document.getElementById('canvasHeightInput').value = canvas.height;
            } else if (type === 'color_adjustments_direct') {
                document.getElementById('imageProperties').style.display = 'block';
                document.getElementById('colorAdjustments').style.display = 'block';

                const targetObjectForColorAdjust = canvas.getActiveObject() || canvas.backgroundImage;
                if (targetObjectForColorAdjust && targetObjectForColorAdjust.type === 'image') {
                    const filters = targetObjectForColorAdjust.filters || [];
                    document.getElementById('brightnessRange').value = filters[0] && filters[0].type === 'Brightness' ? (filters[0].brightness * 100) + 100 : 100;
                    document.getElementById('contrastRange').value = filters[1] && filters[1].type === 'Contrast' ? (filters[1].contrast * 100) + 100 : 100;
                    document.getElementById('saturationRange').value = filters[2] && filters[2].type === 'Saturation' ? (filters[2].saturation * 100) + 100 : 100;
                    document.getElementById('hueRange').value = filters[3] && filters[3].type === 'HueRotation' ? (filters[3].rotation * 360 / (2 * Math.PI)) : 0;
                } else {
                    document.getElementById('brightnessRange').value = 100;
                    document.getElementById('contrastRange').value = 100;
                    document.getElementById('saturationRange').value = 100;
                    document.getElementById('hueRange').value = 0;
                }
            }
        }

        function hidePropertyPanel() {
            document.getElementById('propertyPanel').classList.remove('active');
        }

        // --- Core Fabric.js & Canvas Manipulation Functions ---
        let currentEditingTextObject = null;

        function openAddNewTextModal() {
            document.getElementById('addTextModal').classList.add('active');
            document.getElementById('textInputArea').value = '';
            document.getElementById('confirmAddUpdateTextBtn').textContent = 'Add Text';
            document.getElementById('confirmAddUpdateTextBtn').onclick = addTextToCanvas;
            currentEditingTextObject = null;
        }

        function openEditTextModal() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                currentEditingTextObject = activeObject;
                document.getElementById('addTextModal').classList.add('active');
                document.getElementById('textInputArea').value = activeObject.text;
                document.getElementById('confirmAddUpdateTextBtn').textContent = 'Update Text';
                document.getElementById('confirmAddUpdateTextBtn').onclick = updateTextOnCanvas;
            } else {
                alert('এডিট করতে অনুগ্রহ করে একটি টেক্সট নির্বাচন করুন!');
            }
        }

        function addTextToCanvas() {
            const textValue = document.getElementById('textInputArea').value;
            if (textValue.trim() === '') {
                alert('অনুগ্রহ করে কিছু টেক্সট টাইপ করুন!');
                return;
            }
            const text = new fabric.IText(textValue, {
                left: canvas.width / 2,
                top: canvas.height / 2,
                fontSize: 80,
                fill: '#000000',
                fontFamily: 'Noto Serif Bengali',
                fontWeight: '700',
                originX: 'center',
                originY: 'center',
                editable: true
            });
            canvas.add(text);
            canvas.setActiveObject(text);
            canvas.renderAll();
            saveCanvasState();
            hideModal('addTextModal');
        }

        function updateTextOnCanvas() {
            if (currentEditingTextObject) {
                currentEditingTextObject.set({ text: document.getElementById('textInputArea').value });
                canvas.renderAll();
                saveCanvasState();
            }
            hideModal('addTextModal');
            currentEditingTextObject = null;
        }

        function addShape(shapeType) {
            let shape;
            const options = {
                left: canvas.width / 2,
                top: canvas.height / 2,
                fill: '#3498db',
                stroke: '#2980b9',
                strokeWidth: 2,
                originX: 'center',
                originY: 'center',
                width: 200,
                height: 200
            };

            if (shapeType === 'rect') {
                shape = new fabric.Rect(options);
            } else if (shapeType === 'circle') {
                shape = new fabric.Circle({ ...options, radius: 100 });
            } else if (shapeType === 'triangle') {
                shape = new fabric.Triangle(options);
            }

            if (shape) {
                canvas.add(shape);
                canvas.setActiveObject(shape);
                canvas.renderAll();
                showPropertyPanel('shape');
            }
            hideModal('addShapeModal');
        }

        let cropper;
        let cropperApplyPurpose = '';

        function triggerFileInput(inputId) {
            document.getElementById(inputId).click();
        }

        function initCropper(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const imageToCropElement = document.getElementById('imageToCrop');
                imageToCropElement.src = e.target.result;

                if (cropper) {
                    cropper.destroy();
                }

                cropper = new Cropper(imageToCropElement, {
                    aspectRatio: NaN,
                    viewMode: 1,
                    movable: true,
                    zoomable: true,
                    rotatable: false,
                    scalable: true,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    autoCropArea: 0.8
                });

                document.getElementById('cropAndApplyBtn').style.display = 'block';
                document.querySelectorAll('.crop-aspect-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('.crop-aspect-btn[data-aspect="NaN"]').classList.add('active');
            };
            reader.readAsDataURL(file);
        }

        document.getElementById('cropAndApplyBtn').addEventListener('click', function() {
            if (!cropper) return;

            const croppedCanvas = cropper.getCroppedCanvas();
            const croppedDataURL = croppedCanvas.toDataURL('image/png');

            if (cropperApplyPurpose === 're-crop') {
                const activeObject = canvas.getActiveObject();
                if (activeObject && activeObject.type === 'image') {
                    fabric.Image.fromURL(croppedDataURL, function(img) {
                        activeObject.setSrc(img.getSrc(), function() {
                            activeObject.set({
                                width: img.width,
                                height: img.height,
                                scaleX: activeObject.scaleX,
                                scaleY: activeObject.scaleY,
                                left: activeObject.left,
                                top: activeObject.top,
                                opacity: activeObject.opacity,
                                filters: activeObject.filters || [],
                                overlayColor: activeObject.overlayColor,
                                overlayOpacity: activeObject.overlayOpacity,
                                compositeOperation: activeObject.compositeOperation,
                                clipPath: activeObject.clipPath
                            });
                            activeObject.applyFilters();
                            canvas.renderAll();
                            saveCanvasState();
                        });
                    });
                }
            } else if (cropperApplyPurpose === 'overlay') {
                fabric.Image.fromURL(croppedDataURL, function(img) {
                    img.set({
                        left: canvas.width / 2,
                        top: canvas.height / 2,
                        scaleX: 0.3,
                        scaleY: 0.3,
                        originX: 'center',
                        originY: 'center'
                    });
                    canvas.add(img);
                    canvas.setActiveObject(img);
                    canvas.renderAll();
                    saveCanvasState();
                });
            } else if (cropperApplyPurpose === 'background') {
                fabric.Image.fromURL(croppedDataURL, function(img) {
                    img.scaleToWidth(canvas.width);
                    img.scaleToHeight(canvas.height);
                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                        scaleX: canvas.width / img.width,
                        scaleY: canvas.height / img.height,
                        filters: img.filters || []
                    });
                    if (canvas.backgroundImage) {
                        canvas.backgroundImage.applyFilters();
                    }
                    canvas.renderAll();
                    saveCanvasState();
                });
            }

            hideModal('imageCropperModal');
        });

        document.querySelectorAll('.crop-aspect-btn').forEach(button => {
            button.addEventListener('click', function() {
                if (cropper) {
                    const aspect = parseFloat(this.dataset.aspect);
                    cropper.setAspectRatio(aspect);
                    document.querySelectorAll('.crop-aspect-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                }
            });
        });

        function showCropperModal(isExistingImage = false, purpose = 'overlay') {
            showModal('imageCropperModal');
            cropperApplyPurpose = purpose;

            if (isExistingImage) {
                const activeObject = canvas.getActiveObject();
                if (activeObject && activeObject.type === 'image') {
                    const imgElement = document.getElementById('imageToCrop');
                    imgElement.src = activeObject.toDataURL({ format: 'png', quality: 1.0 }); 
                    
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(imgElement, {
                        aspectRatio: NaN, 
                        viewMode: 1,
                        autoCropArea: 0.8
                    });
                    document.getElementById('cropAndApplyBtn').style.display = 'block';
                    document.querySelectorAll('.crop-aspect-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelector('.crop-aspect-btn[data-aspect="NaN"]').classList.add('active'); 
                } else {
                    alert('রি-ক্রপ করার জন্য অনুগ্রহ করে ক্যানভাসে একটি ছবি নির্বাচন করুন!');
                    hideModal('imageCropperModal');
                }
            }
        }

        function toggleImageRoundness() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'image') {
                if (activeObject.clipPath) {
                    activeObject.clipPath = null;
                } else {
                    const radius = Math.min(activeObject.width, activeObject.height) / 2;
                    activeObject.set({
                        clipPath: new fabric.Circle({
                            radius: radius,
                            originX: 'center',
                            originY: 'center',
                            absolutePositioned: true
                        })
                    });
                }
                canvas.renderAll();
                saveCanvasState();
            } else {
                alert('বৃত্তাকার করতে অনুগ্রহ করে একটি ছবি নির্বাচন করুন!');
            }
        }

        function toggleLockObjectFromGlobalButton() {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                toggleLockObjectFromLayer(activeObject);
            } else {
                alert('লক/আনলক করতে অনুগ্রহ করে একটি অবজেক্ট নির্বাচন করুন!');
            }
        }

        function toggleLockObjectFromLayer(obj) {
            const newSelectableState = !obj.selectable;

            obj.set({
                selectable: newSelectableState,
                evented: newSelectableState,
                hasControls: newSelectableState,
                lockMovementX: !newSelectableState,
                lockMovementY: !newSelectableState,
                lockRotation: !newSelectableState,
                lockScalingX: !newSelectableState,
                lockScalingY: !newSelectableState,
                lockSkewingX: !newSelectableState,
                lockSkewingY: !newSelectableState
            });

            if (!newSelectableState) {
                canvas.discardActiveObject();
            } else {
                canvas.setActiveObject(obj);
            }
            
            canvas.renderAll();
            saveCanvasState();
            updateLayersPanel();
            updateGlobalLockButton();
        }

        function updateGlobalLockButton() {
            const globalLockBtn = document.getElementById('globalLockUnlockBtn');
            const activeObject = canvas.getActiveObject();

            if (activeObject && !activeObject.selectable) {
                globalLockBtn.innerHTML = '<i class="fas fa-lock-open"></i>';
                globalLockBtn.classList.add('locked');
            } else {
                globalLockBtn.innerHTML = '<i class="fas fa-lock"></i>';
                globalLockBtn.classList.remove('locked');
            }
        }

        function applyImageFilters() {
            const activeObject = canvas.getActiveObject();
            let targetObject = null;

            if (activeObject && activeObject.type === 'image') {
                targetObject = activeObject;
            } else if (canvas.backgroundImage && canvas.backgroundImage.type === 'image') {
                targetObject = canvas.backgroundImage;
            } else {
                document.getElementById('brightnessRange').value = 100;
                document.getElementById('contrastRange').value = 100;
                document.getElementById('saturationRange').value = 100;
                document.getElementById('hueRange').value = 0;
                return;
            }

            const brightness = (parseFloat(document.getElementById('brightnessRange').value) - 100) / 100;
            const contrast = (parseFloat(document.getElementById('contrastRange').value) - 100) / 100;
            const saturation = (parseFloat(document.getElementById('saturationRange').value) - 100) / 100;
            const hue = (parseFloat(document.getElementById('hueRange').value) * Math.PI * 2) / 360;

            targetObject.filters = targetObject.filters || [];

            const updateFilter = (filterType, index, options) => {
                if (targetObject.filters[index] && targetObject.filters[index].type === filterType) {
                    Object.assign(targetObject.filters[index], options);
                } else {
                    switch (filterType) {
                        case 'Brightness': targetObject.filters[index] = new fabric.Image.filters.Brightness(options); break;
                        case 'Contrast': targetObject.filters[index] = new fabric.Image.filters.Contrast(options); break;
                        case 'Saturation': targetObject.filters[index] = new fabric.Image.filters.Saturation(options); break;
                        case 'HueRotation': targetObject.filters[index] = new fabric.Image.filters.HueRotation(options); break;
                    }
                }
            };

            updateFilter('Brightness', 0, { brightness: brightness });
            updateFilter('Contrast', 1, { contrast: contrast });
            updateFilter('Saturation', 2, { saturation: saturation });
            updateFilter('HueRotation', 3, { rotation: hue });

            targetObject.applyFilters();
            canvas.renderAll();
        }

        function removeBackground() {
            canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas));
            canvas.backgroundColor = '#ffffff';
            canvas.renderAll();
            saveCanvasState();
        }

        function deleteSelectedObject() {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                if (confirm('নির্বাচিত আইটেমটি মুছে ফেলবেন?')) {
                    canvas.remove(activeObject);
                    canvas.discardActiveObject();
                    canvas.renderAll();
                    hidePropertyPanel();
                    saveCanvasState();
                }
            } else {
                alert('মুছে ফেলার জন্য কোনো অবজেক্ট নির্বাচিত হয়নি!');
            }
        }

        function bringForward() {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                activeObject.bringForward();
                canvas.renderAll();
                saveCanvasState();
            }
        }

        function sendBackward() {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                activeObject.sendBackward();
                canvas.renderAll();
                saveCanvasState();
            }
        }

        function downloadThumbnail(format = 'png') {
            let dataURL;
            let filename = 'design';
            
            if (format === 'svg') {
                // Convert canvas to SVG
                const svg = canvas.toSVG();
                const blob = new Blob([svg], {type: 'image/svg+xml;charset=utf-8'});
                saveAs(blob, `${filename}.svg`);
                return;
            } else {
                // For PNG and JPG
                dataURL = canvas.toDataURL({
                    format: format,
                    quality: 0.9,
                    multiplier: 1
                });
                filename += format === 'png' ? '.png' : '.jpg';
            }
            
            const link = document.createElement('a');
            link.download = filename;
            link.href = dataURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function clearCanvas() {
            if (confirm('পুরো ক্যানভাস মুছে ফেলবেন?')) {
                canvas.clear();
                removeBackground();
                canvas.backgroundColor = '#ffffff';
                canvas.renderAll();
                hidePropertyPanel();
                addInitialGuidingText();
                saveCanvasState();
            }
        }

        function addInitialGuidingText() {
            canvas.add(new fabric.IText('আপনার থাম্বনেইল ডিজাইন শুরু করুন!', {
                left: canvas.width / 2,
                top: canvas.height / 2,
                fontSize: 100,
                fill: '#555',
                fontFamily: 'Noto Serif Bengali',
                fontWeight: '700',
                originX: 'center',
                originY: 'center',
                editable: true
            }));
            canvas.renderAll();
        }

        function loadTemplate(templateId) {
            if (confirm('টেমপ্লেট লোড করলে বর্তমান ডিজাইন মুছে যাবে। চালিয়ে যেতে চান?')) {
                canvas.clear();
                removeBackground();
                canvas.backgroundColor = '#ffffff';

                if (templateId === 1) {
                    canvas.backgroundColor = '#f1c40f';
                    const text1 = new fabric.IText('ইউটিউব থাম্বনেইল টিপস', {
                        left: canvas.width / 2, top: canvas.height * 0.3,
                        fontSize: 120, fill: '#e74c3c', fontFamily: 'Baloo Da 2', fontWeight: '700',
                        originX: 'center', originY: 'center'
                    });
                    const text2 = new fabric.IText('সহজেই তৈরি করুন!', {
                        left: canvas.width / 2, top: canvas.height * 0.6,
                        fontSize: 80, fill: '#2c3e50', fontFamily: 'Hind Siliguri',
                        originX: 'center', originY: 'center'
                    });
                    canvas.add(text1, text2);
                } else if (templateId === 2) {
                    canvas.backgroundColor = '#3498db';
                    fabric.Image.fromURL('https://via.placeholder.com/600x400/2ecc71/ffffff?text=Your+Image', function(img) {
                        img.scaleToWidth(canvas.width * 0.5);
                        img.set({ left: canvas.width * 0.25, top: canvas.height * 0.2, originX: 'center', originY: 'center' });
                        canvas.add(img);
                        const text = new fabric.IText('Creative Layout', {
                            left: canvas.width * 0.7, top: canvas.height * 0.5,
                            fontSize: 90, fill: '#ffffff', fontFamily: 'Poppins', fontWeight: '700',
                            originX: 'center', originY: 'center'
                        });
                        canvas.add(text);
                        const rect = new fabric.Rect({
                            left: canvas.width * 0.7, top: canvas.height * 0.8,
                            width: 300, height: 90, fill: '#f1c40f',
                            originX: 'center', originY: 'center', rx: 15, ry: 15
                        });
                        const subText = new fabric.IText('Click Here', {
                            left: canvas.width * 0.7, top: canvas.height * 0.8,
                            fontSize: 45, fill: '#2c3e50', fontFamily: 'Roboto', fontWeight: 'bold',
                            originX: 'center', originY: 'center'
                        });
                        canvas.add(rect, subText);
                        canvas.renderAll();
                        saveCanvasState();
                    });
                } else if (templateId === 3) {
                    canvas.backgroundColor = '#e74c3c';
                    const rect = new fabric.Rect({
                        left: canvas.width / 2, top: canvas.height / 2,
                        width: canvas.width * 0.8, height: canvas.height * 0.6,
                        fill: 'rgba(0,0,0,0.4)',
                        originX: 'center', originY: 'center',
                        rx: 30, ry: 30
                    });
                    const text = new fabric.IText('WOW! New Video', {
                        left: canvas.width / 2, top: canvas.height * 0.4,
                        fontSize: 120, fill: '#ffffff', fontFamily: 'Oswald', fontWeight: '700',
                        originX: 'center', originY: 'center'
                    });
                    const subText = new fabric.IText('Don\'t Miss Out!', {
                        left: canvas.width / 2, top: canvas.height * 0.6,
                        fontSize: 60, fill: '#f1c40f', fontFamily: 'Roboto',
                        originX: 'center', originY: 'center'
                    });
                    canvas.add(rect, text, subText);
                } else if (templateId === 4) {
                    canvas.backgroundColor = '#2ecc71';
                    fabric.Image.fromURL('https://via.placeholder.com/300x300/f1c40f/ffffff?text=Profile', function(img) {
                        img.scaleToWidth(canvas.width * 0.2);
                        img.set({ left: canvas.width * 0.15, top: canvas.height * 0.5, originX: 'center', originY: 'center', clipPath: new fabric.Circle({ radius: img.width / 2, originX: 'center', originY: 'center'}) });
                        canvas.add(img);
                        const text1 = new fabric.IText('How to Make', {
                            left: canvas.width * 0.6, top: canvas.height * 0.3,
                            fontSize: 100, fill: '#ffffff', fontFamily: 'Permanent Marker',
                            originX: 'center', originY: 'center'
                        });
                        const text2 = new fabric.IText('Awesome Thumbnails!', {
                            left: canvas.width * 0.6, top: canvas.height * 0.6,
                            fontSize: 90, fill: '#2c3e50', fontFamily: 'Luckiest Guy',
                            originX: 'center', originY: 'center'
                        });
                        canvas.add(text1, text2);
                        canvas.renderAll();
                        saveCanvasState();
                    });
                }
                canvas.renderAll();
                saveCanvasState();
                hideModal('templateModal');
            }
        }

        /* --- Canvas Zoom/Pan --- */
        let currentZoom = 1;
        const zoomStep = 0.1;
        const maxZoom = 3;
        const minZoom = 0.1;

        function zoomIn() {
            currentZoom = Math.min(maxZoom, currentZoom + zoomStep);
            updateCanvasZoom();
        }

        function zoomOut() {
            currentZoom = Math.max(minZoom, currentZoom - zoomStep);
            updateCanvasZoom();
        }

        function resetZoom() {
            currentZoom = 1;
            updateCanvasZoom();
        }

        function updateCanvasZoom() {
            const canvasWrapper = document.querySelector('.canvas-wrapper');
            canvas.setZoom(currentZoom);
            canvas.renderAll();
        }
        
        /* --- Canvas Resizing --- */
        function applyCanvasSize() {
            const newWidth = parseInt(document.getElementById('canvasWidthInput').value);
            const newHeight = parseInt(document.getElementById('canvasHeightInput').value);

            if (isNaN(newWidth) || isNaN(newHeight) || newWidth < 100 || newHeight < 100) {
                alert('অনুগ্রহ করে সঠিক প্রস্থ এবং উচ্চতা দিন (সর্বনিম্ন 100px)।');
                return;
            }

            if (confirm(`ক্যানভাসের আকার ${newWidth}x${newHeight} তে পরিবর্তন করবেন? এটি বিদ্যমান ডিজাইন উপাদানগুলিকে প্রভাবিত করতে পারে।`)) {
                canvas.setDimensions({ width: newWidth, height: newHeight });
                canvas.getObjects().forEach(obj => {
                    if (obj !== canvas.backgroundImage) {
                        obj.set({
                            left: (obj.left / canvas.width) * newWidth, 
                            top: (obj.top / canvas.height) * newHeight
                        });
                        obj.setCoords(); 
                    }
                });
                canvas.renderAll();
                saveCanvasState();
                resizeCanvas(); 
                updateCanvasZoom(); 
            }
            hidePropertyPanel();
        }

        function resizeCanvasToDefault() {
            document.getElementById('canvasWidthInput').value = 5000;
            document.getElementById('canvasHeightInput').value = 5000;
            applyCanvasSize();
        }

        /* --- Layers Panel Functions --- */
        function updateLayersPanel() {
            const layerListDiv = document.getElementById('layerList');
            layerListDiv.innerHTML = '';

            let objects = canvas.getObjects().slice();
            if (canvas.backgroundImage) {
                const bgObj = Object.assign({}, canvas.backgroundImage);
                bgObj.type = 'image';
                bgObj.name = 'Background Image';
                bgObj._isBackground = true;
                bgObj.selectable = canvas.backgroundImage.selectable !== undefined ? canvas.backgroundImage.selectable : false;
                bgObj.evented = canvas.backgroundImage.evented !== undefined ? canvas.backgroundImage.evented : false;
                objects.unshift(bgObj);
            }

            objects.forEach((obj, index) => {
                const layerItem = document.createElement('div');
                layerItem.className = 'layer-item';
                
                if (canvas.getActiveObject() === obj) {
                    layerItem.classList.add('active');
                } else if (obj._isBackground && canvas.backgroundImage === canvas.getActiveObject()) {
                }

                let layerName = 'Unknown Object';
                let layerIcon = 'fas fa-square';
                if (obj.type === 'i-text') {
                    layerName = obj.text.length > 20 ? obj.text.substring(0, 20) + '...' : obj.text || `Text Layer ${index}`;
                    layerIcon = 'fas fa-font';
                } else if (obj.type === 'image') {
                    layerName = obj._isBackground ? 'Background Image' : `Image Layer ${index}`;
                    layerIcon = 'fas fa-image';
                } else if (obj.type === 'rect') {
                    layerName = `Rectangle ${index}`;
                    layerIcon = 'fas fa-square';
                } else if (obj.type === 'circle') {
                    layerName = `Circle ${index}`;
                    layerIcon = 'fas fa-circle';
                } else if (obj.type === 'triangle') {
                    layerName = `Triangle ${index}`;
                    layerIcon = 'fas fa-caret-up';
                } else if (obj.type === 'group') {
                    layerName = `Group ${index}`;
                    layerIcon = 'fas fa-object-group';
                }

                const isLocked = !obj.selectable;
                layerItem.innerHTML = `
                    <i class="${layerIcon} layer-icon"></i>
                    <span class="layer-name">${layerName}</span>
                    <button class="layer-lock-btn ${isLocked ? 'locked' : ''}" title="${isLocked ? 'Unlock' : 'Lock'}">
                        <i class="${isLocked ? 'fas fa-lock-open' : 'fas fa-lock'}"></i>
                    </button>
                `;

                layerItem.addEventListener('click', (e) => {
                    if (!obj._isBackground) {
                        canvas.setActiveObject(obj);
                        canvas.renderAll();
                    }
                });

                const lockButton = layerItem.querySelector('.layer-lock-btn');
                lockButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (obj._isBackground) {
                        alert('ব্যাকগ্রাউন্ড ইমেজকে সরাসরি লেয়ার প্যানেল থেকে লক/আনলক করা যাবে না। অনুগ্রহ করে ক্যানভাসে ছবি হিসেবে যোগ করুন যদি এটিকে লক/আনলক করতে চান।');
                    } else {
                        toggleLockObjectFromLayer(obj);
                    }
                });

                layerListDiv.appendChild(layerItem);
            });
            showModal('layersPanelModal');
        }

        /* --- Event Listeners and Canvas Responsiveness --- */
        addInitialGuidingText();

        canvas.on('selection:created', function(e) {
            if (e.target) { 
                if (e.target.type === 'i-text') {
                    showPropertyPanel('text');
                    document.getElementById('modalTextColorInput').value = e.target.getSelectionStyles()[0]?.fill || e.target.fill || '#000000';
                    document.getElementById('editTextBtn').style.display = 'block';
                } else {
                    document.getElementById('editTextBtn').style.display = 'none';
                }
                if (e.target.type === 'image') {
                    showPropertyPanel('image');
                } else if (e.target.type === 'rect' || e.target.type === 'circle' || e.target.type === 'triangle') {
                    showPropertyPanel('shape');
                }
                updateGlobalLockButton();
            }
        });

        canvas.on('selection:updated', function(e) {
            if (e.target) {
                if (e.target.type === 'i-text') {
                    showPropertyPanel('text');
                    document.getElementById('modalTextColorInput').value = e.target.getSelectionStyles()[0]?.fill || e.target.fill || '#000000';
                    document.getElementById('editTextBtn').style.display = 'block';
                } else {
                    document.getElementById('editTextBtn').style.display = 'none';
                }
                if (e.target.type === 'image') {
                    showPropertyPanel('image');
                } else if (e.target.type === 'rect' || e.target.type === 'circle' || e.type === 'triangle') {
                    showPropertyPanel('shape');
                }
                updateGlobalLockButton();
            }
        });

        canvas.on('selection:cleared', function() {
            hidePropertyPanel();
            document.getElementById('editTextBtn').style.display = 'none';
            updateGlobalLockButton();
        });

        /* --- Property Panel Input Listeners --- */
        document.getElementById('panelTextInput').addEventListener('input', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                activeObject.set({ text: this.value });
                canvas.renderAll();
            }
        });
        document.getElementById('panelTextInput').addEventListener('change', saveCanvasState); 

        document.getElementById('panelFontSize').addEventListener('input', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                activeObject.set({ fontSize: parseInt(this.value) });
                canvas.renderAll();
            }
        });
        document.getElementById('panelFontSize').addEventListener('change', saveCanvasState);

        document.getElementById('modalTextColorInput').addEventListener('input', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                if (activeObject.isEditing && activeObject.selectionStart !== activeObject.selectionEnd) {
                    activeObject.setSelectionStyles({ fill: this.value });
                } else {
                    activeObject.set({ fill: this.value });
                }
                canvas.renderAll();
            }
        });
        document.getElementById('modalTextColorInput').addEventListener('change', saveCanvasState); 

        function applyTextColorFromModal() {
            const activeObject = canvas.getActiveObject();
            const selectedColor = document.getElementById('modalTextColorInput').value;
            if (activeObject && activeObject.type === 'i-text') {
                if (activeObject.isEditing && activeObject.selectionStart !== activeObject.selectionEnd) {
                    activeObject.setSelectionStyles({ fill: selectedColor });
                } else {
                    activeObject.set({ fill: selectedColor });
                }
                canvas.renderAll();
                saveCanvasState();
            }
            hideModal('textColorPickerModal');
        }

        document.querySelectorAll('#textColorPickerModal .color-option-box').forEach(box => {
            box.addEventListener('click', function() {
                const color = this.dataset.color;
                document.getElementById('modalTextColorInput').value = color;
                applyTextColorFromModal();
            });
        });

        document.getElementById('boldBtn').addEventListener('click', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                activeObject.set({ fontWeight: activeObject.fontWeight === 'bold' ? 'normal' : 'bold' });
                this.classList.toggle('active', activeObject.fontWeight === 'bold');
                canvas.renderAll();
                saveCanvasState();
            }
        });
        document.getElementById('italicBtn').addEventListener('click', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                activeObject.set({ fontStyle: activeObject.fontStyle === 'italic' ? 'normal' : 'italic' });
                this.classList.toggle('active', activeObject.fontStyle === 'italic');
                canvas.renderAll();
                saveCanvasState();
            }
        });
        document.getElementById('underlineBtn').addEventListener('click', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                activeObject.set({ underline: !activeObject.underline });
                this.classList.toggle('active', activeObject.underline);
                canvas.renderAll();
                saveCanvasState();
            }
        });

        document.getElementById('textStrokeColor').addEventListener('input', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                activeObject.set({ stroke: this.value });
                canvas.renderAll();
            }
        });
        document.getElementById('textStrokeColor').addEventListener('change', saveCanvasState);

        document.getElementById('textStrokeWidth').addEventListener('input', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                activeObject.set({ strokeWidth: parseInt(this.value) });
                canvas.renderAll();
            }
        });
        document.getElementById('textStrokeWidth').addEventListener('change', saveCanvasState);

        function updateTextShadow() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                activeObject.set({
                    shadow: new fabric.Shadow({
                        color: document.getElementById('textShadowColor').value,
                        blur: parseInt(document.getElementById('textShadowBlur').value),
                        offsetX: parseInt(document.getElementById('textShadowOffsetX').value),
                        offsetY: parseInt(document.getElementById('textShadowOffsetY').value)
                    })
                });
                canvas.renderAll();
            }
        }
        document.getElementById('textShadowColor').addEventListener('input', updateTextShadow);
        document.getElementById('textShadowBlur').addEventListener('input', updateTextShadow);
        document.getElementById('textShadowOffsetX').addEventListener('input', updateTextShadow);
        document.getElementById('textShadowOffsetY').addEventListener('input', updateTextShadow);
        document.getElementById('textShadowColor').addEventListener('change', saveCanvasState);
        document.getElementById('textShadowBlur').addEventListener('change', saveCanvasState);
        document.getElementById('textShadowOffsetX').addEventListener('change', saveCanvasState);
        document.getElementById('textShadowOffsetY').addEventListener('change', saveCanvasState);

        function updateTextBackground() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                const color = document.getElementById('textBgColor').value;
                const opacity = parseFloat(document.getElementById('textBgOpacity').value);
                const radius = parseInt(document.getElementById('textBgRadius').value);

                activeObject.set({
                    backgroundColor: new fabric.Color(color).setAlpha(opacity).toRgba(),
                    textBackgroundRadius: radius 
                });
                canvas.renderAll();
            }
        }
        document.getElementById('textBgColor').addEventListener('input', updateTextBackground);
        document.getElementById('textBgOpacity').addEventListener('input', updateTextBackground);
        document.getElementById('textBgRadius').addEventListener('input', updateTextBackground);
        document.getElementById('textBgColor').addEventListener('change', saveCanvasState);
        document.getElementById('textBgOpacity').addEventListener('change', saveCanvasState);
        document.getElementById('textBgRadius').addEventListener('change', saveCanvasState);

        document.getElementById('panelOpacity').addEventListener('input', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'image') {
                activeObject.set({ opacity: parseFloat(this.value) });
                canvas.renderAll();
            }
        });
        document.getElementById('panelOpacity').addEventListener('change', saveCanvasState);

        document.getElementById('panelShapeColor').addEventListener('input', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && (activeObject.type === 'rect' || activeObject.type === 'circle' || activeObject.type === 'triangle')) {
                activeObject.set({ fill: this.value });
                canvas.renderAll();
            }
        });
        document.getElementById('panelShapeColor').addEventListener('change', saveCanvasState);

        document.getElementById('panelShapeBorderColor').addEventListener('input', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && (activeObject.type === 'rect' || activeObject.type === 'circle' || activeObject.type === 'triangle')) {
                activeObject.set({ stroke: this.value });
                canvas.renderAll();
            }
        });
        document.getElementById('panelShapeBorderColor').addEventListener('change', saveCanvasState);

        document.getElementById('panelShapeBorderWidth').addEventListener('input', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && (activeObject.type === 'rect' || activeObject.type === 'circle' || activeObject.type === 'triangle')) {
                activeObject.set({ strokeWidth: parseInt(this.value) });
                canvas.renderAll();
            }
        });
        document.getElementById('panelShapeBorderWidth').addEventListener('change', saveCanvasState);

        document.getElementById('panelShapeOpacity').addEventListener('input', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && (activeObject.type === 'rect' || activeObject.type === 'circle' || activeObject.type === 'triangle')) {
                activeObject.set({ opacity: parseFloat(this.value) });
                canvas.renderAll();
            }
        });
        document.getElementById('panelShapeOpacity').addEventListener('change', saveCanvasState);

        document.getElementById('panelBgColor').addEventListener('input', function() {
            canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas));
            canvas.backgroundColor = this.value;
            canvas.renderAll();
        });
        document.getElementById('panelBgColor').addEventListener('change', saveCanvasState);

        document.querySelectorAll('.color-box').forEach(box => {
            box.addEventListener('click', function() {
                const color = this.dataset.color;
                document.getElementById('panelBgColor').value = color;
                canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas));
                canvas.backgroundColor = color;
                canvas.renderAll();
                saveCanvasState();
            });
        });

        document.getElementById('canvasWidthInput').addEventListener('change', applyCanvasSize);
        document.getElementById('canvasHeightInput').addEventListener('change', applyCanvasSize);

        document.getElementById('brightnessRange').addEventListener('input', applyImageFilters);
        document.getElementById('contrastRange').addEventListener('input', applyImageFilters);
        document.getElementById('saturationRange').addEventListener('input', applyImageFilters);
        document.getElementById('hueRange').addEventListener('input', applyImageFilters);
        document.getElementById('brightnessRange').addEventListener('change', saveCanvasState);
        document.getElementById('contrastRange').addEventListener('change', saveCanvasState);
        document.getElementById('saturationRange').addEventListener('change', saveCanvasState);
        document.getElementById('hueRange').addEventListener('change', saveCanvasState);

        /* --- Top Menu Bar Button Event Listeners --- */
        document.getElementById('downloadBtn').addEventListener('click', function() {
            downloadThumbnail('png');
        });
        document.getElementById('clearCanvasBtn').addEventListener('click', clearCanvas);
        document.getElementById('undoBtn').addEventListener('click', undo);
        document.getElementById('redoBtn').addEventListener('click', redo);
        
        /* --- Bottom Toolbar Button Event Listeners --- */
        document.getElementById('addNewTextBtn').addEventListener('click', openAddNewTextModal);
        document.getElementById('editTextBtn').addEventListener('click', openEditTextModal);
        
        document.getElementById('openTextColorModalBtn').addEventListener('click', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                document.getElementById('modalTextColorInput').value = activeObject.getSelectionStyles()[0]?.fill || activeObject.fill || '#000000';
                showModal('textColorPickerModal');
            } else {
                alert('রঙ পরিবর্তন করতে অনুগ্রহ করে ক্যানভাসে একটি টেক্সট নির্বাচন করুন!');
            }
        });
        
        document.getElementById('openFontModalBtn').addEventListener('click', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                document.querySelectorAll('#fontSelectionModal .font-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.font === activeObject.fontFamily) {
                        item.classList.add('active');
                    }
                });
                showModal('fontSelectionModal');
            } else {
                alert('ফন্ট পরিবর্তন করতে অনুগ্রহ করে ক্যানভাসে একটি টেক্সট নির্বাচন করুন!');
            }
        });

        document.querySelectorAll('#fontSelectionModal .font-item').forEach(item => {
            item.addEventListener('click', function() {
                const activeObject = canvas.getActiveObject();
                if (activeObject && activeObject.type === 'i-text') {
                    const selectedFont = this.dataset.font;
                    activeObject.set({ fontFamily: selectedFont });
                    canvas.renderAll();
                    saveCanvasState();
                    hideModal('fontSelectionModal');
                }
            });
        });

        document.getElementById('openTextGradientModalBtn').addEventListener('click', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                if (activeObject.fill && activeObject.fill.colorStops) {
                    document.getElementById('gradientColor1').value = activeObject.fill.colorStops[0].color;
                    document.getElementById('gradientColor2').value = activeObject.fill.colorStops[1].color;
                } else {
                    document.getElementById('gradientColor1').value = '#ff0000';
                    document.getElementById('gradientColor2').value = '#0000ff';
                }
                showModal('textGradientModal');
            } else {
                alert('গ্রেডিয়েন্ট প্রয়োগ করতে অনুগ্রহ করে একটি টেক্সট নির্বাচন করুন!');
            }
        });

        document.querySelectorAll('#textGradientModal .gradient-direction button').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#textGradientModal .gradient-direction button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });

        function applyTextGradient() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                const color1 = document.getElementById('gradientColor1').value;
                const color2 = document.getElementById('gradientColor2').value;
                const activeDirectionBtn = document.querySelector('#textGradientModal .gradient-direction button.active');
                const directionAngle = activeDirectionBtn ? parseInt(activeDirectionBtn.dataset.direction) : 0;

                let coords;
                if (directionAngle === 0) {
                    coords = { x1: 0, y1: activeObject.height / 2, x2: activeObject.width, y2: activeObject.height / 2 };
                } else if (directionAngle === 90) {
                    coords = { x1: activeObject.width / 2, y1: 0, x2: activeObject.width / 2, y2: activeObject.height };
                } else if (directionAngle === 45) {
                    coords = { x1: 0, y1: 0, x2: activeObject.width, y2: activeObject.height };
                } else if (directionAngle === 135) {
                    coords = { x1: activeObject.width, y1: 0, x2: 0, y2: activeObject.height };
                }
                
                const gradient = new fabric.Gradient({
                    type: 'linear',
                    coords: coords,
                    colorStops: [
                        { offset: 0, color: color1 },
                        { offset: 1, color: color2 }
                    ]
                });
                
                activeObject.set({ fill: gradient });
                canvas.renderAll();
                saveCanvasState();
            }
            hideModal('textGradientModal');
        }

        document.getElementById('addShapeBtn').addEventListener('click', () => showModal('addShapeModal'));
        document.getElementById('addOverlayImageBtn').addEventListener('click', () => showCropperModal(false, 'overlay'));
        document.getElementById('setBgImageBtn').addEventListener('click', () => showCropperModal(false, 'background'));
        document.getElementById('setBgColorBtn').addEventListener('click', () => showPropertyPanel('background_color'));
        document.getElementById('openColorAdjustmentsBtn').addEventListener('click', () => showPropertyPanel('color_adjustments_direct'));
        document.getElementById('loadTemplateBtn').addEventListener('click', () => showModal('templateModal'));
        document.getElementById('canvasSizeBtn').addEventListener('click', () => showPropertyPanel('canvas_size'));
        document.getElementById('openLayersPanelBtn').addEventListener('click', updateLayersPanel);
        document.getElementById('deleteObjectBtn').addEventListener('click', deleteSelectedObject);

        /* Zoom controls action buttons */
        document.getElementById('zoomInBtn').addEventListener('click', zoomIn);
        document.getElementById('zoomOutBtn').addEventListener('click', zoomOut);
        document.getElementById('resetZoomBtn').addEventListener('click', resetZoom);

        /* Download format buttons */
        document.getElementById('downloadPngBtn').addEventListener('click', function() {
            downloadThumbnail('png');
        });
        document.getElementById('downloadJpgBtn').addEventListener('click', function() {
            downloadThumbnail('jpeg');
        });
        document.getElementById('downloadSvgBtn').addEventListener('click', function() {
            downloadThumbnail('svg');
        });

        /* Lock Object Button in Property Panel */
        document.getElementById('globalLockUnlockBtn').addEventListener('click', toggleLockObjectFromGlobalButton);

        /* Image Roundness button */
        document.getElementById('toggleImageRoundnessBtn').addEventListener('click', toggleImageRoundness);

        /* Color Overlay Modal for images */
        document.getElementById('overlayColorInput').addEventListener('input', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'image') {
                activeObject.set({ fill: this.value, overlayColor: this.value });
                canvas.renderAll();
            }
        });
        document.getElementById('overlayOpacityRange').addEventListener('input', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'image') {
                activeObject.set({ opacity: parseFloat(this.value), overlayOpacity: parseFloat(this.value) });
                canvas.renderAll();
            }
        });
        document.querySelectorAll('#colorOverlayModal .color-option-box').forEach(box => {
            box.addEventListener('click', function() {
                const color = this.dataset.color;
                document.getElementById('overlayColorInput').value = color;
                const activeObject = canvas.getActiveObject();
                if (activeObject && activeObject.type === 'image') {
                    activeObject.set({ fill: color, overlayColor: color });
                    canvas.renderAll();
                }
            });
        });

        /* --- Canvas Responsiveness and Initial Setup --- */
        function resizeCanvas() {
            const canvasArea = document.querySelector('.canvas-area');
            const availableWidth = canvasArea.offsetWidth - 20;
            const availableHeight = canvasArea.offsetHeight - 20;

            let newWidth, newHeight;
            const aspectRatio = 16 / 9;

            if (availableWidth / availableHeight > aspectRatio) { 
                newHeight = availableHeight;
                newWidth = availableHeight * aspectRatio;
            } else { 
                newWidth = availableWidth;
                newHeight = availableWidth / aspectRatio;
            }
            
            const canvasWrapper = document.querySelector('.canvas-wrapper');
            canvasWrapper.style.width = `${newWidth}px`;
            canvasWrapper.style.height = `${newHeight}px`;

            updateCanvasZoom();
        }

        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('orientationchange', resizeCanvas);
        resizeCanvas();

        // Custom render function for text background radius
        fabric.IText.prototype._renderTextBackground = function(ctx) {
            if (!this.backgroundColor && !this.textBackgroundRadius) {
                return;
            }
            let dim = this._getTextWidthHeight(ctx, this.text);
            ctx.fillStyle = this.backgroundColor || 'transparent';
            
            const textLeft = -dim.width / 2;
            const textTop = -dim.height / 2;
            const radius = this.textBackgroundRadius || 0;

            ctx.beginPath();
            ctx.moveTo(textLeft + radius, textTop);
            ctx.lineTo(textLeft + dim.width - radius, textTop);
            ctx.quadraticCurveTo(textLeft + dim.width, textTop, textLeft + dim.width, textTop + radius);
            ctx.lineTo(textLeft + dim.width, textTop + dim.height - radius);
            ctx.quadraticCurveTo(textLeft + dim.width, textTop + dim.height, textLeft + dim.width - radius, textTop + dim.height);
            ctx.lineTo(textLeft + radius, textTop + dim.height);
            ctx.quadraticCurveTo(textLeft, textTop + dim.height, textLeft, textTop + dim.height - radius);
            ctx.lineTo(textLeft, textTop + radius);
            ctx.quadraticCurveTo(textLeft, textTop, textLeft + radius, textTop);
            ctx.closePath();
            ctx.fill();
        };
    </script>
</body>
</html>
