<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Thumbnail Designer</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght@400;500&family=Baloo+Da+2:wght@400;600&family=Hind+Siliguri:wght@400;600&family=Noto+Serif+Bengali:wght@400;600&family=Anek+Bangla:wght@400;600&family=Rajdhani:wght@400;600&family=Atma:wght@400;600&family=Galada:wght@400;600&family=Moulpali:wght@400;600&family=Tiro+Bangla:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">

    <style>
        /* CSS Variables for theming */
        :root {
            --primary-color: #f44336; /* Deep Red for actions/accents */
            --secondary-color: #212121; /* Dark Black/Grey for sidebars */
            --accent-color: #424242; /* Medium Grey for buttons/hover */
            --bg-light: #eceff1; /* Light Grey for main background */
            --bg-dark: #b0bec5; /* Medium Grey for canvas area */
            --text-dark: #212121;
            --text-light: #ffffff;
            --border-color: rgba(255, 255, 255, 0.15);
            --shadow-soft: 0 2px 5px rgba(0, 0, 0, 0.15);
            --shadow-medium: 0 5px 15px rgba(0, 0, 0, 0.25);
            --border-radius: 8px;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            background-color: var(--bg-light);
            min-height: 100vh;
            overflow: hidden; /* Prevent scrolling */
            touch-action: pan-y; /* Prevent vertical scrolling on touch */
            color: var(--text-dark);
        }

        /* Portrait mode warning */
        @media (orientation: portrait) {
            body::before {
                content: "অনুগ্রহ করে সেরা অভিজ্ঞতার জন্য আপনার ডিভাইসটি অনুভূমিক (Landscape) মোডে ঘোরান।\nPlease rotate your device to landscape mode for best experience.";
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background-color: rgba(0, 0, 0, 0.95);
                color: var(--text-light);
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 1.5em;
                z-index: 9999;
                text-align: center;
                padding: 20px;
                box-sizing: border-box;
            }
            .app-container {
                display: none !important; /* Hide app in portrait */
            }
        }

        .app-container {
            display: flex;
            flex-grow: 1;
            background-color: var(--text-light);
            box-shadow: var(--shadow-medium);
            overflow: hidden;
            border-radius: var(--border-radius);
            margin: 10px;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 70px; /* Wider for better touch targets */
            background-color: var(--secondary-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
            box-shadow: var(--shadow-soft);
            z-index: 10;
            border-radius: var(--border-radius);
        }

        .sidebar button {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.6em; /* Larger icons */
            padding: 15px 0;
            width: 100%;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            outline: none;
        }

        .sidebar button:hover,
        .sidebar button.active {
            background-color: var(--primary-color);
            color: var(--text-light);
            transform: scale(1.05);
        }
        .sidebar button:active {
            transform: scale(0.95);
        }
        .sidebar button[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: transparent;
            transform: none;
        }

        /* Canvas Area */
        .canvas-area {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--bg-dark);
            position: relative;
            padding: 10px;
            overflow: hidden; /* For zoom/pan effect */
        }

        .canvas-wrapper {
            position: relative;
            width: 100%;
            max-width: 1280px;
            height: auto;
            aspect-ratio: 16 / 9;
            background-color: var(--text-light);
            border: 3px solid var(--primary-color);
            box-shadow: var(--shadow-medium);
            border-radius: var(--border-radius);
            overflow: hidden;
            touch-action: none; /* Crucial for Fabric.js touch events */
            transform-origin: center center;
            transition: transform 0.1s ease-out; /* Smooth zoom */
        }
        canvas {
            display: block;
        }

        /* Floating Controls (like Layer/Undo/Redo) */
        .floating-controls {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background-color: rgba(33, 33, 33, 0.9); /* secondary-color with transparency */
            padding: 8px 15px;
            border-radius: 25px;
            box-shadow: var(--shadow-medium);
            z-index: 20;
        }
        .floating-controls button {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.2em;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .floating-controls button:hover:not([disabled]),
        .floating-controls button:active:not([disabled]) {
            background-color: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        .floating-controls button[disabled] {
            color: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
        }

        /* Zoom controls */
        .zoom-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            background-color: rgba(33, 33, 33, 0.8);
            border-radius: var(--border-radius);
            padding: 5px;
            box-shadow: var(--shadow-soft);
            z-index: 20;
        }
        .zoom-controls button {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.1em;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .zoom-controls button:hover, .zoom-controls button:active {
            background-color: var(--accent-color);
        }


        /* Property Panel (Popup from right) */
        .property-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px; /* Wider panel for more controls */
            height: 100vh;
            background-color: var(--text-light);
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.25);
            z-index: 100;
            display: flex;
            flex-direction: column;
            padding: 20px;
            transform: translateX(100%); /* Start off-screen */
            transition: transform 0.3s ease-out;
            overflow-y: auto; /* Enable scrolling for long panels */
        }
        .property-panel.active {
            transform: translateX(0); /* Slide in */
        }
        .property-panel h3 {
            font-family: 'Poppins', sans-serif;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.6em;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .property-panel label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95em;
        }
        .property-panel input[type="text"],
        .property-panel input[type="number"],
        .property-panel input[type="color"],
        .property-panel select,
        .property-panel input[type="range"] {
            width: calc(100% - 18px); /* Adjust for padding */
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 1em;
            background-color: var(--bg-light);
            color: var(--text-dark);
        }

        .property-panel .close-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: none;
            border: none;
            color: var(--text-dark);
            font-size: 1.8em;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        .property-panel .close-btn:hover {
            background-color: var(--bg-light);
        }
        .property-group {
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 20px;
            background-color: var(--bg-light);
        }
        .property-group h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--secondary-color);
            font-size: 1.2em;
            border-bottom: 1px dashed #ccc;
            padding-bottom: 8px;
        }
        .property-group .button-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .property-group .button-row button {
            background-color: var(--accent-color);
            color: var(--text-light);
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            flex-grow: 1;
            transition: background-color 0.2s;
        }
        .property-group .button-row button:hover {
            background-color: #555;
        }
        .color-palette {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        .color-box {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: transform 0.1s ease;
        }
        .color-box:hover {
            transform: scale(1.1);
            border-color: var(--primary-color);
        }


        /* Fullscreen Overlay for Modals/Popups (e.g., Image Upload, Templates, Font Selection, Color Picker) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: var(--text-light);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            padding: 25px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-content .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: var(--text-dark);
            font-size: 1.8em;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        .modal-content .close-btn:hover {
            background-color: var(--bg-light);
        }

        /* Image Upload/Crop Modal specific styles */
        #imageCropperModal .modal-body {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        #imageCropperModal .image-preview-container {
            max-width: 100%;
            max-height: 400px; /* Limit height for cropper */
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
        }
        #imageCropperModal .image-preview-container img {
            display: block; /* Important for Cropper.js */
            max-width: 100%; /* Important for Cropper.js */
        }
        #imageCropperModal .crop-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        #imageCropperModal .crop-controls button {
            background-color: var(--accent-color);
            color: var(--text-light);
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        #imageCropperModal .crop-controls button.active {
            background-color: var(--primary-color);
        }
        #imageCropperModal .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        #imageCropperModal .modal-buttons button {
            flex-grow: 1;
            background-color: var(--accent-color);
            color: var(--text-light);
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        #imageCropperModal .modal-buttons button.cancel {
            background-color: #b0bec5; /* Light grey for cancel */
            color: var(--text-dark);
        }

        /* Hidden file input */
        .hidden-file-input {
            display: none;
        }

        /* Template Modal specific styles */
        .template-grid, .font-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Responsive grid */
            gap: 15px;
            margin-top: 15px;
        }
        .template-item, .font-item {
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
            box-shadow: var(--shadow-soft);
        }
        .template-item:hover, .font-item:hover {
            transform: translateY(-3px);
            border-color: var(--primary-color);
        }
        .template-item img {
            width: 100%;
            height: auto;
            display: block;
        }
        .template-item p, .font-item p {
            background-color: #f9f9f9;
            padding: 8px;
            margin: 0;
            font-size: 0.9em;
            text-align: center;
            color: var(--text-dark);
            font-family: 'Poppins', sans-serif;
            overflow: hidden; /* Prevent text overflow */
            white-space: nowrap; /* Prevent text wrap */
            text-overflow: ellipsis; /* Add ellipsis if text overflows */
        }
        .font-item p {
            font-size: 1.2em; /* Larger font preview */
            padding: 15px 8px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .font-item.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.5);
        }

        /* Color Picker Modal */
        #textColorPickerModal .color-options, #colorOverlayModal .color-options {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 20px;
            justify-items: center;
        }
        #textColorPickerModal .color-option-box, #colorOverlayModal .color-option-box {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: transform 0.1s ease, border-color 0.2s;
            box-shadow: var(--shadow-soft);
        }
        #textColorPickerModal .color-option-box:hover, #colorOverlayModal .color-option-box:hover {
            transform: scale(1.1);
            border-color: var(--primary-color);
        }
        #textColorPickerModal input[type="color"], #colorOverlayModal input[type="color"] {
            width: 100%;
            height: 50px;
            margin-top: 20px;
            padding: 0;
            border: none;
            background: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar left">
            <button id="addTextBtn" title="Add Text"><i class="fas fa-font"></i></button>
            <button id="openTextColorModalBtn" title="Text Color"><i class="fas fa-palette"></i></button>
            <button id="openFontModalBtn" title="Text Font"><i class="fas fa-text-height"></i></button>
            <button id="addShapeBtn" title="Add Shape"><i class="fas fa-shapes"></i></button>
            <button id="addOverlayImageBtn" title="Add Overlay Image"><i class="fas fa-images"></i></button> <button id="setBgImageBtn" title="Set Background Image"><i class="fas fa-image-polaroid"></i></button> <button id="setBgColorBtn" title="Background Color"><i class="fas fa-fill-drip"></i></button>
            <button id="loadTemplateBtn" title="Load Template"><i class="fas fa-layer-group"></i></button>
            <button id="canvasSizeBtn" title="Canvas Size"><i class="fas fa-expand-arrows-alt"></i></button>
        </div>

        <div class="canvas-area">
            <div class="canvas-wrapper">
                <canvas id="thumbnailCanvas"></canvas>
            </div>
            <div class="floating-controls">
                <button id="undoBtn" title="Undo" disabled><i class="fas fa-undo"></i></button>
                <button id="redoBtn" title="Redo" disabled><i class="fas fa-redo"></i></button>
                <button id="bringForwardBtn" title="Bring Forward"><i class="fas fa-arrow-up"></i></button>
                <button id="sendBackwardBtn" title="Send Backward"><i class="fas fa-arrow-down"></i></button>
            </div>
            <div class="zoom-controls">
                <button id="zoomInBtn" title="Zoom In"><i class="fas fa-search-plus"></i></button>
                <button id="zoomOutBtn" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
                <button id="resetZoomBtn" title="Reset Zoom"><i class="fas fa-compress"></i></button>
            </div>
        </div>

        <div class="sidebar right">
            <button id="deleteObjectBtn" title="Delete Selected"><i class="fas fa-trash-alt"></i></button>
            <button id="clearCanvasBtn" title="Clear Canvas"><i class="fas fa-eraser"></i></button>
            <button id="downloadBtn" title="Download Thumbnail"><i class="fas fa-download"></i></button>
        </div>

        <div id="propertyPanel" class="property-panel">
            <button class="close-btn" onclick="hidePropertyPanel()"><i class="fas fa-times"></i></button>
            <h3>Properties</h3>

            <div class="property-group">
                <h4>Common Settings</h4>
                <div class="button-row">
                    <button id="lockObjectBtn"><i class="fas fa-lock"></i> Lock Object</button> </div>
            </div>

            <div id="textProperties" style="display:none;" class="property-group">
                <h4>Text Settings</h4>
                <label for="panelTextInput">Text:</label>
                <input type="text" id="panelTextInput">

                <label for="panelFontSize">Font Size:</label>
                <input type="number" id="panelFontSize" min="10">
               
                <div class="button-row">
                    <button id="boldBtn" title="Bold"><i class="fas fa-bold"></i></button>
                    <button id="italicBtn" title="Italic"><i class="fas fa-italic"></i></button>
                    <button id="underlineBtn" title="Underline"><i class="fas fa-underline"></i></button>
                </div>
            </div>

            <div id="imageProperties" style="display:none;" class="property-group">
                <h4>Image Settings</h4>
                <label for="panelOpacity">Opacity:</label>
                <input type="range" id="panelOpacity" min="0" max="1" step="0.01" value="1">
                <div class="button-row">
                    <button onclick="showCropperModal(true, 're-crop')"><i class="fas fa-crop"></i> Re-crop Image</button>
                    <button onclick="applyColorOverlayModal()"><i class="fas fa-tint"></i> Apply Color Overlay</button>
                </div>
                <div id="colorAdjustments" class="property-group">
                    <h4>Color Adjustments</h4>
                    <label for="brightnessRange">Brightness:</label>
                    <input type="range" id="brightnessRange" min="0" max="200" value="100">
                    <label for="contrastRange">Contrast:</label>
                    <input type="range" id="contrastRange" min="0" max="200" value="100">
                    <label for="saturationRange">Saturation:</label>
                    <input type="range" id="saturationRange" min="0" max="200" value="100">
                    <label for="hueRange">Hue:</label>
                    <input type="range" id="hueRange" min="0" max="360" value="0">
                </div>
            </div>

            <div id="shapeProperties" style="display:none;" class="property-group">
                <h4>Shape Settings</h4>
                <label for="panelShapeColor">Fill Color:</label>
                <input type="color" id="panelShapeColor">
                <label for="panelShapeBorderColor">Border Color:</label>
                <input type="color" id="panelShapeBorderColor">
                <label for="panelShapeBorderWidth">Border Width:</label>
                <input type="number" id="panelShapeBorderWidth" min="0" value="0">
                <label for="panelShapeOpacity">Opacity:</label>
                <input type="range" id="panelShapeOpacity" min="0" max="1" step="0.01" value="1">
            </div>

            <div id="bgColorProperties" style="display:none;" class="property-group">
                <h4>Background Color</h4>
                <label for="panelBgColor">Select Color:</label>
                <input type="color" id="panelBgColor" value="#ffffff">
                <div class="color-palette">
                    <div class="color-box" style="background-color: #ffffff;" data-color="#ffffff"></div>
                    <div class="color-box" style="background-color: #f1c40f;" data-color="#f1c40f"></div>
                    <div class="color-box" style="background-color: #3498db;" data-color="#3498db"></div>
                    <div class="color-box" style="background-color: #2ecc71;" data-color="#2ecc71"></div>
                    <div class="color-box" style="background-color: #e74c3c;" data-color="#e74c3c"></div>
                    <div class="color-box" style="background-color: #9b59b6;" data-color="#9b59b6"></div>
                    <div class="color-box" style="background-color: #1abc9c;" data-color="#1abc9c"></div>
                    <div class="color-box" style="background-color: #e67e22;" data-color="#e67e22"></div>
                    <div class="color-box" style="background-color: #7f8c8d;" data-color="#7f8c8d"></div>
                    <div class="color-box" style="background-color: #2c3e50;" data-color="#2c3e50"></div>
                </div>
                <button onclick="removeBackground()"><i class="fas fa-times-circle"></i> Remove Background Image</button>
            </div>
            
            <div id="canvasSizeProperties" style="display:none;" class="property-group">
                <h4>Canvas Size</h4>
                <label for="canvasWidthInput">Width:</label>
                <input type="number" id="canvasWidthInput" value="1280" min="100">
                <label for="canvasHeightInput">Height:</label>
                <input type="number" id="canvasHeightInput" value="720" min="100">
                <div class="button-row">
                    <button onclick="resizeCanvasToDefault()"><i class="fas fa-undo"></i> Reset to 1280x720</button>
                    <button onclick="applyCanvasSize()"><i class="fas fa-check"></i> Apply Size</button>
                </div>
            </div>
        </div>

        <div id="imageCropperModal" class="modal-overlay"> <div class="modal-content">
                <button class="close-btn" onclick="hideModal('imageCropperModal')"><i class="fas fa-times"></i></button>
                <h3>Upload & Crop Image</h3>
                <div class="modal-body">
                    <input type="file" id="cropperImageInput" class="hidden-file-input" accept="image/*" onchange="initCropper(event)">
                    
                    <div class="image-preview-container">
                        <img id="imageToCrop" src="" alt="Image to Crop">
                    </div>

                    <div class="crop-controls">
                        <button data-aspect="1" class="crop-aspect-btn active">1:1</button>
                        <button data-aspect="1.7777777777777777" class="crop-aspect-btn">16:9</button>
                        <button data-aspect="0.5625" class="crop-aspect-btn">9:16</button>
                        <button data-aspect="NaN" class="crop-aspect-btn">Free</button>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button onclick="triggerFileInput('cropperImageInput')"><i class="fas fa-folder-open"></i> Select Image</button>
                    <button id="cropAndApplyBtn" style="display:none;"><i class="fas fa-cut"></i> Crop & Apply</button>
                    <button class="cancel" onclick="hideModal('imageCropperModal')"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </div>
        </div>

        <div id="templateModal" class="modal-overlay">
            <div class="modal-content">
                <button class="close-btn" onclick="hideModal('templateModal')"><i class="fas fa-times"></i></button>
                <h3>Choose a Template</h3>
                <div class="template-grid">
                    <div class="template-item" onclick="loadTemplate(1)">
                        <img src="https://via.placeholder.com/200x112/f1c40f/ffffff?text=বাংলা+টেমপ্লেট+১" alt="Template 1">
                        <p>বাংলা টাইটেল</p>
                    </div>
                    <div class="template-item" onclick="loadTemplate(2)">
                        <img src="https://via.placeholder.com/200x112/3498db/ffffff?text=Template+2" alt="Template 2">
                        <p>Creative Layout</p>
                    </div>
                     <div class="template-item" onclick="loadTemplate(3)">
                        <img src="https://via.placeholder.com/200x112/e74c3c/ffffff?text=Awesome+Design" alt="Template 3">
                        <p>Awesome Design</p>
                    </div>
                     <div class="template-item" onclick="loadTemplate(4)">
                        <img src="https://via.placeholder.com/200x112/2ecc71/ffffff?text=YouTube+Video" alt="Template 4">
                        <p>YouTube Video</p>
                    </div>
                    </div>
                <div class="modal-buttons">
                    <button class="cancel" onclick="hideModal('templateModal')"><i class="fas fa-times"></i> Close</button>
                </div>
            </div>
        </div>

        <div id="addShapeModal" class="modal-overlay">
            <div class="modal-content">
                <button class="close-btn" onclick="hideModal('addShapeModal')"><i class="fas fa-times"></i></button>
                <h3>Add Shape</h3>
                <div class="modal-buttons">
                    <button onclick="addShape('rect')"><i class="fas fa-square"></i> Rectangle</button>
                    <button onclick="addShape('circle')"><i class="fas fa-circle"></i> Circle</button>
                    <button onclick="addShape('triangle')"><i class="fas fa-caret-up"></i> Triangle</button>
                </div>
                <div class="modal-buttons">
                    <button class="cancel" onclick="hideModal('addShapeModal')"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </div>
        </div>

        <div id="fontSelectionModal" class="modal-overlay">
            <div class="modal-content">
                <button class="close-btn" onclick="hideModal('fontSelectionModal')"><i class="fas fa-times"></i></button>
                <h3>Select Font</h3>
                <div class="font-grid">
                    <div class="font-group">
                        <h4>English Fonts</h4>
                        <div class="font-list">
                            <div class="font-item" data-font="Poppins"><p style="font-family: Poppins;">Poppins</p></div>
                            <div class="font-item" data-font="Roboto"><p style="font-family: Roboto;">Roboto</p></div>
                            <div class="font-item" data-font="Open Sans"><p style="font-family: 'Open Sans';">Open Sans</p></div>
                            <div class="font-item" data-font="Montserrat"><p style="font-family: Montserrat;">Montserrat</p></div>
                            <div class="font-item" data-font="Lato"><p style="font-family: Lato;">Lato</p></div>
                            <div class="font-item" data-font="Oswald"><p style="font-family: Oswald;">Oswald</p></div>
                            <div class="font-item" data-font="Raleway"><p style="font-family: Raleway;">Raleway</p></div>
                            <div class="font-item" data-font="Merriweather"><p style="font-family: Merriweather;">Merriweather</p></div>
                            <div class="font-item" data-font="Playfair Display"><p style="font-family: 'Playfair Display';">Playfair Display</p></div>
                            <div class="font-item" data-font="Lora"><p style="font-family: Lora;">Lora</p></div>
                            </div>
                    </div>
                    <div class="font-group">
                        <h4>বাংলা ফন্ট</h4>
                        <div class="font-list">
                            <div class="font-item" data-font="Baloo Da 2"><p style="font-family: 'Baloo Da 2';">আমার ফন্ট</p></div>
                            <div class="font-item" data-font="Hind Siliguri"><p style="font-family: 'Hind Siliguri';">আমার ফন্ট</p></div>
                            <div class="font-item" data-font="Noto Serif Bengali"><p style="font-family: 'Noto Serif Bengali';">আমার ফন্ট</p></div>
                            <div class="font-item" data-font="Anek Bangla"><p style="font-family: 'Anek Bangla';">আমার ফন্ট</p></div>
                            <div class="font-item" data-font="Rajdhani"><p style="font-family: Rajdhani;">আমার ফন্ট</p></div>
                            <div class="font-item" data-font="Atma"><p style="font-family: Atma;">আমার ফন্ট</p></div>
                            <div class="font-item" data-font="Galada"><p style="font-family: Galada;">আমার ফন্ট</p></div>
                            <div class="font-item" data-font="Moulpali"><p style="font-family: Moulpali;">আমার ফন্ট</p></div>
                            <div class="font-item" data-font="Tiro Bangla"><p style="font-family: 'Tiro Bangla';">আমার ফন্ট</p></div>
                            <div class="font-item" data-font="Monda"><p style="font-family: Monda;">আমার ফন্ট</p></div>
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="textColorPickerModal" class="modal-overlay">
            <div class="modal-content">
                <button class="close-btn" onclick="hideModal('textColorPickerModal')"><i class="fas fa-times"></i></button>
                <h3>Select Text Color</h3>
                <input type="color" id="modalTextColorInput" value="#000000">
                <div class="color-options">
                    <div class="color-option-box" style="background-color: #000000;" data-color="#000000"></div>
                    <div class="color-option-box" style="background-color: #ffffff;" data-color="#ffffff"></div>
                    <div class="color-option-box" style="background-color: #f44336;" data-color="#f44336"></div>
                    <div class="color-option-box" style="background-color: #2196f3;" data-color="#2196f3"></div>
                    <div class="color-option-box" style="background-color: #4caf50;" data-color="#4caf50"></div>
                    <div class="color-option-box" style="background-color: #ffeb3b;" data-color="#ffeb3b"></div>
                    <div class="color-option-box" style="background-color: #ff9800;" data-color="#ff9800"></div>
                    <div class="color-option-box" style="background-color: #9c27b0;" data-color="#9c27b0"></div>
                    <div class="color-option-box" style="background-color: #607d8b;" data-color="#607d8b"></div>
                    <div class="color-option-box" style="background-color: #795548;" data-color="#795548"></div>
                </div>
                <div class="modal-buttons" style="margin-top: 20px;">
                    <button onclick="applyTextColorFromModal()"><i class="fas fa-check-circle"></i> Apply Color</button>
                    <button class="cancel" onclick="hideModal('textColorPickerModal')"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </div>
        </div>

        <div id="colorOverlayModal" class="modal-overlay">
            <div class="modal-content">
                <button class="close-btn" onclick="hideModal('colorOverlayModal')"><i class="fas fa-times"></i></button>
                <h3>Apply Color Overlay</h3>
                <label for="overlayColorInput">Overlay Color:</label>
                <input type="color" id="overlayColorInput" value="#000000">
                <label for="overlayOpacityRange">Overlay Opacity:</label>
                <input type="range" id="overlayOpacityRange" min="0" max="1" step="0.01" value="0">
                <div class="color-options">
                    <div class="color-option-box" style="background-color: #000000;" data-color="#000000"></div>
                    <div class="color-option-box" style="background-color: #ffffff;" data-color="#ffffff"></div>
                    <div class="color-option-box" style="background-color: #f44336;" data-color="#f44336"></div>
                    <div class="color-option-box" style="background-color: #2196f3;" data-color="#2196f3"></div>
                    <div class="color-option-box" style="background-color: #4caf50;" data-color="#4caf50"></div>
                    <div class="color-option-box" style="background-color: #ffeb3b;" data-color="#ffeb3b"></div>
                    <div class="color-option-box" style="background-color: #ff9800;" data-color="#ff9800"></div>
                    <div class="color-option-box" style="background-color: #9c27b0;" data-color="#9c27b0"></div>
                    <div class="color-option-box" style="background-color: #607d8b;" data-color="#607d8b"></div>
                    <div class="color-option-box" style="background-color: #795548;" data-color="#795548"></div>
                </div>
                <div class="modal-buttons" style="margin-top: 20px;">
                    <button onclick="applyColorOverlay()"><i class="fas fa-check-circle"></i> Apply Overlay</button>
                    <button class="cancel" onclick="hideModal('colorOverlayModal')"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </div>
        </div>


    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <script>
        const canvas = new fabric.Canvas('thumbnailCanvas', {
            width: 1280,
            height: 720,
            backgroundColor: '#ffffff'
        });

        // --- Undo/Redo History ---
        let history = [];
        let historyPointer = -1;
        let isRedoing = false;

        function saveCanvasState() {
            if (isRedoing) {
                isRedoing = false;
                history = history.slice(0, historyPointer + 1);
            }
            // Include custom properties in JSON export for locking
            const json = JSON.stringify(canvas.toJSON(['lockMovementX', 'lockMovementY', 'lockRotation', 'lockScalingX', 'lockScalingY', 'lockSkewingX', 'lockSkewingY', 'selectable', 'evented', 'hasControls', 'overlayColor', 'overlayOpacity']));
            history.push(json);
            historyPointer = history.length - 1;
            updateUndoRedoButtons();
        }

        function undo() {
            if (historyPointer > 0) {
                historyPointer--;
                isRedoing = true;
                canvas.loadFromJSON(history[historyPointer], function() {
                    canvas.renderAll();
                    updateUndoRedoButtons();
                    hidePropertyPanel(); /* Hide panel on undo/redo */
                    // Reapply filters after loading from JSON, as Fabric.js might not do it automatically for all filters
                    canvas.getObjects().forEach(obj => {
                        if (obj.type === 'image' && obj.filters && obj.filters.length > 0) {
                            obj.applyFilters();
                        }
                    });
                    if (canvas.backgroundImage && canvas.backgroundImage.filters && canvas.backgroundImage.filters.length > 0) {
                        canvas.backgroundImage.applyFilters();
                    }
                    canvas.renderAll();
                });
            }
        }

        function redo() {
            if (historyPointer < history.length - 1) {
                historyPointer++;
                isRedoing = true;
                canvas.loadFromJSON(history[historyPointer], function() {
                    canvas.renderAll();
                    updateUndoRedoButtons();
                    hidePropertyPanel(); /* Hide panel on undo/redo */
                    // Reapply filters after loading from JSON
                     canvas.getObjects().forEach(obj => {
                        if (obj.type === 'image' && obj.filters && obj.filters.length > 0) {
                            obj.applyFilters();
                        }
                    });
                    if (canvas.backgroundImage && canvas.backgroundImage.filters && canvas.backgroundImage.filters.length > 0) {
                        canvas.backgroundImage.applyFilters();
                    }
                    canvas.renderAll();
                });
            }
        }

        function updateUndoRedoButtons() {
            document.getElementById('undoBtn').disabled = (historyPointer <= 0);
            document.getElementById('redoBtn').disabled = (historyPointer >= history.length - 1);
        }

        // Initialize history with initial canvas state
        saveCanvasState();
        // Save state on specific canvas events for undo/redo
        canvas.on('object:modified', saveCanvasState);
        canvas.on('object:added', saveCanvasState);
        canvas.on('object:removed', saveCanvasState);
        // Note: For complex interactions like dragging/resizing, `modified` covers the final state.
        // For continuous changes (e.g., color slider), use `change` event on input.
        canvas.on('selection:cleared', saveCanvasState); // Save when selection cleared (e.g., locking)


        // --- UI Control & Modal Functions ---
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            // Reset image preview/cropper on close
            if (modalId === 'imageCropperModal') {
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                document.getElementById('imageToCrop').src = "";
                document.getElementById('cropAndApplyBtn').style.display = 'none';
            }
        }

        function showPropertyPanel(type) {
            document.getElementById('propertyPanel').classList.add('active');
            // Hide all property groups first
            document.getElementById('textProperties').style.display = 'none';
            document.getElementById('imageProperties').style.display = 'none';
            document.getElementById('shapeProperties').style.display = 'none';
            document.getElementById('bgColorProperties').style.display = 'none';
            document.getElementById('canvasSizeProperties').style.display = 'none';
            
            // Common properties - Lock Object
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                updateLockObjectButton(!activeObject.selectable);
            } else {
                 updateLockObjectButton(false); // Reset to "Lock Object" when nothing is selected
            }


            if (type === 'text') {
                document.getElementById('textProperties').style.display = 'block';
                if (activeObject && activeObject.type === 'i-text') {
                    document.getElementById('panelTextInput').value = activeObject.text;
                    document.getElementById('panelFontSize').value = activeObject.fontSize;
                    document.getElementById('boldBtn').classList.toggle('active', activeObject.fontWeight === 'bold');
                    document.getElementById('italicBtn').classList.toggle('active', activeObject.fontStyle === 'italic');
                    document.getElementById('underlineBtn').classList.toggle('active', activeObject.underline);
                }
            } else if (type === 'image') {
                document.getElementById('imageProperties').style.display = 'block';
                document.getElementById('colorAdjustments').style.display = 'block'; // Show color adjustments for images
                if (activeObject && activeObject.type === 'image') {
                    document.getElementById('panelOpacity').value = activeObject.opacity;
                    // Populate color adjustments
                    // Filter order: Brightness, Contrast, Saturation, Hue
                    const filters = activeObject.filters || [];
                    document.getElementById('brightnessRange').value = filters[0] && filters[0].type === 'Brightness' ? (filters[0].brightness * 100) + 100 : 100;
                    document.getElementById('contrastRange').value = filters[1] && filters[1].type === 'Contrast' ? (filters[1].contrast * 100) + 100 : 100;
                    document.getElementById('saturationRange').value = filters[2] && filters[2].type === 'Saturation' ? (filters[2].saturation * 100) + 100 : 100;
                    document.getElementById('hueRange').value = filters[3] && filters[3].type === 'HueRotation' ? (filters[3].rotation * 360 / (2 * Math.PI)) : 0;
                }
            } else if (type === 'shape') {
                 document.getElementById('shapeProperties').style.display = 'block';
                 if (activeObject && (activeObject.type === 'rect' || activeObject.type === 'circle' || activeObject.type === 'triangle')) {
                     document.getElementById('panelShapeColor').value = activeObject.fill;
                     document.getElementById('panelShapeBorderColor').value = activeObject.stroke || '#000000';
                     document.getElementById('panelShapeBorderWidth').value = activeObject.strokeWidth || 0;
                     document.getElementById('panelShapeOpacity').value = activeObject.opacity;
                 }
            } else if (type === 'background_color') {
                document.getElementById('bgColorProperties').style.display = 'block';
                document.getElementById('panelBgColor').value = canvas.backgroundColor || '#ffffff';
            } else if (type === 'canvas_size') {
                document.getElementById('canvasSizeProperties').style.display = 'block';
                document.getElementById('canvasWidthInput').value = canvas.width;
                document.getElementById('canvasHeightInput').value = canvas.height;
            }
        }

        function hidePropertyPanel() {
            document.getElementById('propertyPanel').classList.remove('active');
        }

        // --- Core Fabric.js & Canvas Manipulation Functions ---
        function addText() {
            const text = new fabric.IText('আপনার টেক্সট এখানে', {
                left: canvas.width / 2,
                top: canvas.height / 2,
                fontSize: 50,
                fill: '#000000',
                fontFamily: 'Noto Serif Bengali', /* Default Bangla font */
                fontWeight: '700',
                originX: 'center',
                originY: 'center',
                editable: true
            });
            canvas.add(text);
            canvas.setActiveObject(text);
            canvas.renderAll();
        }

        function addShape(shapeType) {
            let shape;
            const options = {
                left: canvas.width / 2,
                top: canvas.height / 2,
                fill: '#3498db', /* Default blue fill */
                stroke: '#2980b9', /* Default darker blue border */
                strokeWidth: 2,
                originX: 'center',
                originY: 'center',
                width: 100, /* Default size */
                height: 100
            };

            if (shapeType === 'rect') {
                shape = new fabric.Rect(options);
            } else if (shapeType === 'circle') {
                shape = new fabric.Circle({ ...options, radius: 50 });
            } else if (shapeType === 'triangle') {
                shape = new fabric.Triangle(options);
            }

            if (shape) {
                canvas.add(shape);
                canvas.setActiveObject(shape);
                canvas.renderAll();
                showPropertyPanel('shape');
            }
            hideModal('addShapeModal');
        }

        let cropper;
        let cropperApplyPurpose = ''; /* 'overlay' or 'background' or 're-crop' */

        function triggerFileInput(inputId) {
            document.getElementById(inputId).click();
        }

        function initCropper(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const imageToCropElement = document.getElementById('imageToCrop');
                imageToCropElement.src = e.target.result;

                if (cropper) {
                    cropper.destroy(); /* Destroy existing cropper instance */
                }

                cropper = new Cropper(imageToCropElement, {
                    aspectRatio: NaN, /* Start with free aspect initially */
                    viewMode: 1, /* Restrict the crop box to not exceed the canvas */
                    movable: true,
                    zoomable: true,
                    rotatable: false,
                    scalable: true,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    autoCropArea: 0.8 /* Auto crop 80% of the image area */
                });

                document.getElementById('cropAndApplyBtn').style.display = 'block'; /* Show crop button */
                document.querySelectorAll('.crop-aspect-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('.crop-aspect-btn[data-aspect="NaN"]').classList.add('active'); /* Activate Free by default */
            };
            reader.readAsDataURL(file);
        }

        document.getElementById('cropAndApplyBtn').addEventListener('click', function() {
            if (!cropper) return;

            const croppedCanvas = cropper.getCroppedCanvas();
            const croppedDataURL = croppedCanvas.toDataURL('image/png');

            if (cropperApplyPurpose === 're-crop') {
                const activeObject = canvas.getActiveObject();
                if (activeObject && activeObject.type === 'image') {
                    fabric.Image.fromURL(croppedDataURL, function(img) {
                        activeObject.setSrc(img.getSrc(), function() {
                            activeObject.set({
                                width: img.width,
                                height: img.height,
                                scaleX: activeObject.scaleX,
                                scaleY: activeObject.scaleY,
                                left: activeObject.left,
                                top: activeObject.top,
                                opacity: activeObject.opacity,
                                filters: activeObject.filters || [], // Keep existing filters
                                overlayColor: activeObject.overlayColor, // Keep overlay color
                                overlayOpacity: activeObject.overlayOpacity, // Keep overlay opacity
                                compositeOperation: activeObject.compositeOperation // Keep composite operation
                            });
                            activeObject.applyFilters(); // Reapply filters
                            canvas.renderAll();
                            saveCanvasState();
                        });
                    });
                }
            } else if (cropperApplyPurpose === 'overlay') {
                fabric.Image.fromURL(croppedDataURL, function(img) {
                    img.set({
                        left: canvas.width / 2,
                        top: canvas.height / 2,
                        scaleX: 0.3, /* Default scale for new images */
                        scaleY: 0.3,
                        originX: 'center',
                        originY: 'center'
                    });
                    canvas.add(img);
                    canvas.setActiveObject(img);
                    canvas.renderAll();
                    saveCanvasState();
                });
            } else if (cropperApplyPurpose === 'background') {
                 fabric.Image.fromURL(croppedDataURL, function(img) {
                    img.scaleToWidth(canvas.width);
                    img.scaleToHeight(canvas.height);
                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                        scaleX: canvas.width / img.width,
                        scaleY: canvas.height / img.height,
                        filters: img.filters || [] // Keep existing filters if background
                    });
                    if (canvas.backgroundImage) {
                         canvas.backgroundImage.applyFilters();
                    }
                    canvas.renderAll();
                    saveCanvasState();
                });
            }

            hideModal('imageCropperModal');
        });

        document.querySelectorAll('.crop-aspect-btn').forEach(button => {
            button.addEventListener('click', function() {
                if (cropper) {
                    const aspect = parseFloat(this.dataset.aspect);
                    cropper.setAspectRatio(aspect);
                    document.querySelectorAll('.crop-aspect-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                }
            });
        });

        function showCropperModal(isExistingImage = false, purpose = 'overlay') { // Added purpose parameter
            showModal('imageCropperModal');
            cropperApplyPurpose = purpose; // Set the purpose for when cropAndApplyBtn is clicked

            if (isExistingImage) { // If re-cropping an existing image on canvas
                const activeObject = canvas.getActiveObject();
                if (activeObject && activeObject.type === 'image') {
                    const imgElement = document.getElementById('imageToCrop');
                    // To get the original image data for re-cropping, it's best to store it or extract from filter
                    // For simplicity, we convert canvas object to dataURL, but filters will be baked in
                    imgElement.src = activeObject.toDataURL({ format: 'png', quality: 1.0 }); 
                    
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(imgElement, {
                        aspectRatio: NaN, 
                        viewMode: 1,
                        autoCropArea: 0.8
                    });
                    document.getElementById('cropAndApplyBtn').style.display = 'block';
                    document.querySelectorAll('.crop-aspect-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelector('.crop-aspect-btn[data-aspect="NaN"]').classList.add('active'); 
                } else {
                    alert('রি-ক্রপ করার জন্য অনুগ্রহ করে ক্যানভাসে একটি ছবি নির্বাচন করুন!');
                    hideModal('imageCropperModal');
                }
            } else { // New image upload
                // No image loaded yet, waits for file input change
            }
        }

        // --- Object Locking ---
        function toggleLockObject() {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                // Toggle selectable state
                const newSelectableState = !activeObject.selectable;

                activeObject.set({
                    selectable: newSelectableState,
                    evented: newSelectableState, // Respond to events only if selectable
                    hasControls: newSelectableState, // Show controls only if selectable
                    lockMovementX: !newSelectableState,
                    lockMovementY: !newSelectableState,
                    lockRotation: !newSelectableState,
                    lockScalingX: !newSelectableState,
                    lockScalingY: !newSelectableState,
                    // Note: Skewing locks are typically tied to scaling locks or `hasControls` implicitly
                    // Explicitly set them if needed for granular control
                    lockSkewingX: !newSelectableState,
                    lockSkewingY: !newSelectableState
                });

                // If object becomes unselectable, discard active selection
                if (!newSelectableState) {
                    canvas.discardActiveObject();
                } else {
                    // If object becomes selectable, re-select it to show controls
                    canvas.setActiveObject(activeObject);
                }
                
                canvas.renderAll();
                saveCanvasState();
                updateLockObjectButton(newSelectableState); // Update button based on the *new* selectable state
            } else {
                alert('লক/আনলক করার জন্য অনুগ্রহ করে একটি অবজেক্ট নির্বাচন করুন!');
            }
        }

        function updateLockObjectButton(isSelectable) { // Parameter is now `isSelectable`
            const lockBtn = document.getElementById('lockObjectBtn');
            if (isSelectable) { // If currently selectable, button should say "Lock"
                lockBtn.innerHTML = '<i class="fas fa-lock"></i> Lock Object';
                lockBtn.classList.remove('active');
            } else { // If currently not selectable (locked), button should say "Unlock"
                lockBtn.innerHTML = '<i class="fas fa-lock-open"></i> Unlock Object';
                lockBtn.classList.add('active');
            }
        }

        // --- Color Grading / Image Filters ---
        function applyImageFilters() {
            const activeObject = canvas.getActiveObject();
            // Check for both active object and active background image
            let targetObject = null;
            if (activeObject && activeObject.type === 'image') {
                targetObject = activeObject;
            } else if (canvas.backgroundImage && canvas.backgroundImage.type === 'image') {
                // If background is an image and no active object is selected, apply to background
                // This logic is simplified; a more robust app might explicitly differentiate.
                targetObject = canvas.backgroundImage;
            }

            if (targetObject) {
                const brightness = (parseFloat(document.getElementById('brightnessRange').value) - 100) / 100;
                const contrast = (parseFloat(document.getElementById('contrastRange').value) - 100) / 100;
                const saturation = (parseFloat(document.getElementById('saturationRange').value) - 100) / 100;
                const hue = (parseFloat(document.getElementById('hueRange').value) * Math.PI * 2) / 360; // Convert degrees to radians

                targetObject.filters = targetObject.filters || [];

                // Fabric.js filters: Brightness, Contrast, Saturation, HueRotation
                // Ensure correct filter types are at expected indices or add new ones
                const updateFilter = (filterType, index, options) => {
                    if (targetObject.filters[index] && targetObject.filters[index].type === filterType) {
                        Object.assign(targetObject.filters[index], options);
                    } else {
                        switch (filterType) {
                            case 'Brightness': targetObject.filters[index] = new fabric.Image.filters.Brightness(options); break;
                            case 'Contrast': targetObject.filters[index] = new fabric.Image.filters.Contrast(options); break;
                            case 'Saturation': targetObject.filters[index] = new fabric.Image.filters.Saturation(options); break;
                            case 'HueRotation': targetObject.filters[index] = new fabric.Image.filters.HueRotation(options); break;
                            // Add other filters as needed
                        }
                    }
                };

                updateFilter('Brightness', 0, { brightness: brightness });
                updateFilter('Contrast', 1, { contrast: contrast });
                updateFilter('Saturation', 2, { saturation: saturation });
                updateFilter('HueRotation', 3, { rotation: hue });

                targetObject.applyFilters();
                canvas.renderAll();
                // saveCanvasState() is called on 'change' event of range inputs
            }
        }


        function removeBackground() {
            canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas));
            canvas.backgroundColor = '#ffffff'; /* Reset to white */
            canvas.renderAll();
            saveCanvasState();
        }

        function deleteSelectedObject() {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                if (confirm('নির্বাচিত আইটেমটি মুছে ফেলবেন?')) {
                    canvas.remove(activeObject);
                    canvas.discardActiveObject();
                    canvas.renderAll();
                    hidePropertyPanel();
                    saveCanvasState();
                }
            } else {
                alert('মুছে ফেলার জন্য কোনো অবজেক্ট নির্বাচিত হয়নি!');
            }
        }

        function bringForward() {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                activeObject.bringForward();
                canvas.renderAll();
                saveCanvasState();
            }
        }

        function sendBackward() {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                activeObject.sendBackward();
                canvas.renderAll();
                saveCanvasState();
            }
        }

        function downloadThumbnail() {
            const dataURL = canvas.toDataURL({
                format: 'png',
                quality: 1.0,
                multiplier: 2
            });
            const link = document.createElement('a');
            link.download = 'youtube_thumbnail.png';
            link.href = dataURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function clearCanvas() {
            if (confirm('পুরো ক্যানভাস মুছে ফেলবেন?')) {
                canvas.clear();
                removeBackground();
                canvas.backgroundColor = '#ffffff';
                canvas.renderAll();
                hidePropertyPanel();
                addInitialGuidingText();
                saveCanvasState();
            }
        }

        function addInitialGuidingText() {
            canvas.add(new fabric.IText('আপনার থাম্বনেইল ডিজাইন শুরু করুন!', {
                left: canvas.width / 2,
                top: canvas.height / 2,
                fontSize: 60,
                fill: '#555',
                fontFamily: 'Noto Serif Bengali',
                fontWeight: '700',
                originX: 'center',
                originY: 'center',
                editable: true
            }));
            canvas.renderAll();
        }

        /* --- Template Loading Functions --- */
        function loadTemplate(templateId) {
            if (confirm('টেমপ্লেট লোড করলে বর্তমান ডিজাইন মুছে যাবে। চালিয়ে যেতে চান?')) {
                canvas.clear();
                removeBackground();
                canvas.backgroundColor = '#ffffff';

                if (templateId === 1) {
                    canvas.backgroundColor = '#f1c40f'; /* Yellow background */
                    const text1 = new fabric.IText('ইউটিউব থাম্বনেইল টিপস', {
                        left: canvas.width / 2, top: canvas.height * 0.3,
                        fontSize: 80, fill: '#e74c3c', fontFamily: 'Baloo Da 2', fontWeight: '700',
                        originX: 'center', originY: 'center'
                    });
                    const text2 = new fabric.IText('সহজেই তৈরি করুন!', {
                        left: canvas.width / 2, top: canvas.height * 0.6,
                        fontSize: 50, fill: '#2c3e50', fontFamily: 'Hind Siliguri',
                        originX: 'center', originY: 'center'
                    });
                    canvas.add(text1, text2);
                } else if (templateId === 2) {
                    canvas.backgroundColor = '#3498db'; /* Blue background */
                    fabric.Image.fromURL('https://via.placeholder.com/600x400/2ecc71/ffffff?text=Your+Image', function(img) {
                        img.scaleToWidth(canvas.width * 0.5);
                        img.set({ left: canvas.width * 0.25, top: canvas.height * 0.2, originX: 'center', originY: 'center' });
                        canvas.add(img);
                        const text = new fabric.IText('Creative Layout', {
                            left: canvas.width * 0.7, top: canvas.height * 0.5,
                            fontSize: 60, fill: '#ffffff', fontFamily: 'Poppins', fontWeight: '700',
                            originX: 'center', originY: 'center'
                        });
                        canvas.add(text);
                        const rect = new fabric.Rect({
                            left: canvas.width * 0.7, top: canvas.height * 0.8,
                            width: 200, height: 60, fill: '#f1c40f',
                            originX: 'center', originY: 'center', rx: 10, ry: 10
                        });
                        const subText = new fabric.IText('Click Here', {
                            left: canvas.width * 0.7, top: canvas.height * 0.8,
                            fontSize: 30, fill: '#2c3e50', fontFamily: 'Roboto', fontWeight: 'bold',
                            originX: 'center', originY: 'center'
                        });
                        canvas.add(rect, subText);
                        canvas.renderAll();
                        saveCanvasState();
                    });
                } else if (templateId === 3) {
                     canvas.backgroundColor = '#e74c3c'; /* Red background */
                    const rect = new fabric.Rect({
                        left: canvas.width / 2, top: canvas.height / 2,
                        width: canvas.width * 0.8, height: canvas.height * 0.6,
                        fill: 'rgba(0,0,0,0.4)',
                        originX: 'center', originY: 'center',
                        rx: 20, ry: 20 /* Rounded corners */
                    });
                    const text = new fabric.IText('WOW! New Video', {
                        left: canvas.width / 2, top: canvas.height * 0.4,
                        fontSize: 90, fill: '#ffffff', fontFamily: 'Oswald', fontWeight: '700',
                        originX: 'center', originY: 'center'
                    });
                     const subText = new fabric.IText('Don\'t Miss Out!', {
                        left: canvas.width / 2, top: canvas.height * 0.6,
                        fontSize: 40, fill: '#f1c40f', fontFamily: 'Roboto',
                        originX: 'center', originY: 'center'
                    });
                    canvas.add(rect, text, subText);
                } else if (templateId === 4) {
                    canvas.backgroundColor = '#2ecc71'; /* Green background */
                    fabric.Image.fromURL('https://via.placeholder.com/300x300/f1c40f/ffffff?text=Profile', function(img) {
                        img.scaleToWidth(canvas.width * 0.2);
                        img.set({ left: canvas.width * 0.15, top: canvas.height * 0.5, originX: 'center', originY: 'center', clipPath: new fabric.Circle({ radius: img.width / 2, originX: 'center', originY: 'center'}) });
                        canvas.add(img);
                        const text1 = new fabric.IText('How to Make', {
                            left: canvas.width * 0.6, top: canvas.height * 0.3,
                            fontSize: 70, fill: '#ffffff', fontFamily: 'Permanent Marker',
                            originX: 'center', originY: 'center'
                        });
                        const text2 = new fabric.IText('Awesome Thumbnails!', {
                            left: canvas.width * 0.6, top: canvas.height * 0.6,
                            fontSize: 60, fill: '#2c3e50', fontFamily: 'Luckiest Guy',
                            originX: 'center', originY: 'center'
                        });
                        canvas.add(text1, text2);
                        canvas.renderAll();
                        saveCanvasState();
                    });
                }
                canvas.renderAll();
                saveCanvasState();
                hideModal('templateModal');
            }
        }

        /* --- Canvas Zoom/Pan --- */
        let currentZoom = 1;
        const zoomStep = 0.1;
        const maxZoom = 2;
        const minZoom = 0.5;

        function zoomIn() {
            currentZoom = Math.min(maxZoom, currentZoom + zoomStep);
            updateCanvasZoom();
        }

        function zoomOut() {
            currentZoom = Math.max(minZoom, currentZoom - zoomStep);
            updateCanvasZoom();
        }

        function resetZoom() {
            currentZoom = 1;
            updateCanvasZoom();
        }

        function updateCanvasZoom() {
            const canvasWrapper = document.querySelector('.canvas-wrapper');
            const originalWidth = 1280; /* The Fabric.js canvas's fixed width */
            const currentWrapperWidth = canvasWrapper.offsetWidth; /* Current actual width of the wrapper */

            const baseZoom = currentWrapperWidth / originalWidth;
            
            canvas.setZoom(currentZoom * baseZoom);
            canvas.renderAll();
        }
        
        /* --- Canvas Resizing --- */
        function applyCanvasSize() {
            const newWidth = parseInt(document.getElementById('canvasWidthInput').value);
            const newHeight = parseInt(document.getElementById('canvasHeightInput').value);

            if (isNaN(newWidth) || isNaN(newHeight) || newWidth < 100 || newHeight < 100) {
                alert('অনুগ্রহ করে সঠিক প্রস্থ এবং উচ্চতা দিন (সর্বনিম্ন 100px)।');
                return;
            }

            if (confirm(`ক্যানভাসের আকার ${newWidth}x${newHeight} তে পরিবর্তন করবেন? এটি বিদ্যমান ডিজাইন উপাদানগুলিকে প্রভাবিত করতে পারে।`)) {
                canvas.setDimensions({ width: newWidth, height: newHeight });
                canvas.getObjects().forEach(obj => {
                    if (obj !== canvas.backgroundImage) {
                        obj.set({
                            left: (obj.left / canvas.width) * newWidth, 
                            top: (obj.top / canvas.height) * newHeight
                        });
                        obj.setCoords(); 
                    }
                });
                canvas.renderAll();
                saveCanvasState();
                resizeCanvas(); 
                updateCanvasZoom(); 
            }
            hidePropertyPanel();
        }

        function resizeCanvasToDefault() {
            document.getElementById('canvasWidthInput').value = 1280;
            document.getElementById('canvasHeightInput').value = 720;
            applyCanvasSize();
        }


        /* --- Event Listeners and Canvas Responsiveness --- */
        addInitialGuidingText(); /* Initial text */

        /* IMPORTANT: Selection event listeners for property panel */
        canvas.on('selection:created', function(e) {
            if (e.target) { 
                if (e.target.type === 'i-text') {
                    showPropertyPanel('text');
                    document.getElementById('modalTextColorInput').value = e.target.fill;
                } else if (e.target.type === 'image') {
                    showPropertyPanel('image');
                } else if (e.target.type === 'rect' || e.target.type === 'circle' || e.target.type === 'triangle') {
                    showPropertyPanel('shape');
                }
                updateLockObjectButton(e.target.selectable); // Update lock button state based on current selectable state
            }
        });

        canvas.on('selection:updated', function(e) {
            if (e.target) {
                 if (e.target.type === 'i-text') {
                    showPropertyPanel('text');
                    document.getElementById('modalTextColorInput').value = e.target.fill;
                } else if (e.target.type === 'image') {
                    showPropertyPanel('image');
                } else if (e.target.type === 'rect' || e.target.type === 'circle' || e.target.type === 'triangle') {
                    showPropertyPanel('shape');
                }
                updateLockObjectButton(e.target.selectable);
            }
        });

        canvas.on('selection:cleared', function() {
            hidePropertyPanel();
            updateLockObjectButton(true); // Reset lock button to "Lock Object" when no object is selected (assuming default is unlocked)
        });

        /* --- Property Panel Input Listeners --- */
        document.getElementById('panelTextInput').addEventListener('input', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                activeObject.set({ text: this.value });
                canvas.renderAll();
            }
        });
        document.getElementById('panelTextInput').addEventListener('change', saveCanvasState); 

        document.getElementById('panelFontSize').addEventListener('input', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                activeObject.set({ fontSize: parseInt(this.value) });
                canvas.renderAll();
            }
        });
        document.getElementById('panelFontSize').addEventListener('change', saveCanvasState);

        /* Text Color Change Listener for MODAL picker */
        document.getElementById('modalTextColorInput').addEventListener('input', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                activeObject.set({ fill: this.value });
                canvas.renderAll();
            }
        });
        document.getElementById('modalTextColorInput').addEventListener('change', saveCanvasState); 

        /* Apply Text Color from Modal button */
        function applyTextColorFromModal() {
            const activeObject = canvas.getActiveObject();
            const selectedColor = document.getElementById('modalTextColorInput').value;
            if (activeObject && activeObject.type === 'i-text') {
                activeObject.set({ fill: selectedColor });
                canvas.renderAll();
                saveCanvasState();
            }
            hideModal('textColorPickerModal');
        }

        /* Click listeners for color palette in modal */
        document.querySelectorAll('#textColorPickerModal .color-option-box').forEach(box => {
            box.addEventListener('click', function() {
                const color = this.dataset.color;
                document.getElementById('modalTextColorInput').value = color; /* Update color input */
                applyTextColorFromModal(); /* Apply and close modal */
            });
        });

        /* Font style buttons (Bold, Italic, Underline) */
        document.getElementById('boldBtn').addEventListener('click', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                activeObject.set({ fontWeight: activeObject.fontWeight === 'bold' ? 'normal' : 'bold' });
                this.classList.toggle('active', activeObject.fontWeight === 'bold');
                canvas.renderAll();
                saveCanvasState();
            }
        });
        document.getElementById('italicBtn').addEventListener('click', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                activeObject.set({ fontStyle: activeObject.fontStyle === 'italic' ? 'normal' : 'italic' });
                this.classList.toggle('active', activeObject.fontStyle === 'italic');
                canvas.renderAll();
                saveCanvasState();
            }
        });
        document.getElementById('underlineBtn').addEventListener('click', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                activeObject.set({ underline: !activeObject.underline });
                this.classList.toggle('active', activeObject.underline);
                canvas.renderAll();
                saveCanvasState();
            }
        });

        /* Image Opacity */
        document.getElementById('panelOpacity').addEventListener('input', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'image') {
                activeObject.set({ opacity: parseFloat(this.value) });
                canvas.renderAll();
            }
        });
        document.getElementById('panelOpacity').addEventListener('change', saveCanvasState);

        /* Shape Properties */
        document.getElementById('panelShapeColor').addEventListener('input', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && (activeObject.type === 'rect' || activeObject.type === 'circle' || activeObject.type === 'triangle')) {
                activeObject.set({ fill: this.value });
                canvas.renderAll();
            }
        });
        document.getElementById('panelShapeColor').addEventListener('change', saveCanvasState);

        document.getElementById('panelShapeBorderColor').addEventListener('input', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && (activeObject.type === 'rect' || activeObject.type === 'circle' || activeObject.type === 'triangle')) {
                activeObject.set({ stroke: this.value });
                canvas.renderAll();
            }
        });
        document.getElementById('panelShapeBorderColor').addEventListener('change', saveCanvasState);

        document.getElementById('panelShapeBorderWidth').addEventListener('input', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && (activeObject.type === 'rect' || activeObject.type === 'circle' || activeObject.type === 'triangle')) {
                activeObject.set({ strokeWidth: parseInt(this.value) });
                canvas.renderAll();
            }
        });
        document.getElementById('panelShapeBorderWidth').addEventListener('change', saveCanvasState);

        document.getElementById('panelShapeOpacity').addEventListener('input', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && (activeObject.type === 'rect' || activeObject.type === 'circle' || activeObject.type === 'triangle')) {
                activeObject.set({ opacity: parseFloat(this.value) });
                canvas.renderAll();
            }
        });
        document.getElementById('panelShapeOpacity').addEventListener('change', saveCanvasState);


        /* Background Color picker in Property Panel */
        document.getElementById('panelBgColor').addEventListener('input', function() {
            canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas)); /* Remove image if any */
            canvas.backgroundColor = this.value;
            canvas.renderAll();
        });
        document.getElementById('panelBgColor').addEventListener('change', saveCanvasState);

        document.querySelectorAll('.color-box').forEach(box => {
            box.addEventListener('click', function() {
                const color = this.dataset.color;
                document.getElementById('panelBgColor').value = color;
                canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas));
                canvas.backgroundColor = color;
                canvas.renderAll();
                saveCanvasState();
            });
        });

        /* Canvas Size controls in Property Panel */
        document.getElementById('canvasWidthInput').addEventListener('change', applyCanvasSize);
        document.getElementById('canvasHeightInput').addEventListener('change', applyCanvasSize);

        /* Color Adjustments for Images */
        document.getElementById('brightnessRange').addEventListener('input', applyImageFilters);
        document.getElementById('contrastRange').addEventListener('input', applyImageFilters);
        document.getElementById('saturationRange').addEventListener('input', applyImageFilters);
        document.getElementById('hueRange').addEventListener('input', applyImageFilters);
        document.getElementById('brightnessRange').addEventListener('change', saveCanvasState);
        document.getElementById('contrastRange').addEventListener('change', saveCanvasState);
        document.getElementById('saturationRange').addEventListener('change', saveCanvasState);
        document.getElementById('hueRange').addEventListener('change', saveCanvasState);


        /* --- Sidebar Button Event Listeners --- */
        document.getElementById('addTextBtn').addEventListener('click', addText);
        document.getElementById('addShapeBtn').addEventListener('click', () => showModal('addShapeModal'));
        document.getElementById('addOverlayImageBtn').addEventListener('click', () => showCropperModal(false, 'overlay')); /* New Overlay Image button */
        document.getElementById('setBgImageBtn').addEventListener('click', () => showCropperModal(false, 'background')); /* New Background Image button */
        document.getElementById('setBgColorBtn').addEventListener('click', () => showPropertyPanel('background_color'));
        document.getElementById('loadTemplateBtn').addEventListener('click', () => showModal('templateModal'));
        document.getElementById('canvasSizeBtn').addEventListener('click', () => showPropertyPanel('canvas_size'));

        /* Text Color and Font Modals from sidebar */
        document.getElementById('openTextColorModalBtn').addEventListener('click', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                document.getElementById('modalTextColorInput').value = activeObject.fill; /* Set current color */
                showModal('textColorPickerModal');
            } else {
                alert('রঙ পরিবর্তন করতে অনুগ্রহ করে ক্যানভাসে একটি টেক্সট নির্বাচন করুন!');
            }
        });

        document.getElementById('openFontModalBtn').addEventListener('click', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                document.querySelectorAll('#fontSelectionModal .font-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.font === activeObject.fontFamily) {
                        item.classList.add('active');
                    }
                });
                showModal('fontSelectionModal');
            } else {
                alert('ফন্ট পরিবর্তন করতে অনুগ্রহ করে ক্যানভাসে একটি টেক্সট নির্বাচন করুন!');
            }
        });

        /* Apply font from modal */
        document.querySelectorAll('#fontSelectionModal .font-item').forEach(item => {
            item.addEventListener('click', function() {
                const activeObject = canvas.getActiveObject();
                if (activeObject && activeObject.type === 'i-text') {
                    const selectedFont = this.dataset.font;
                    activeObject.set({ fontFamily: selectedFont });
                    canvas.renderAll();
                    saveCanvasState();
                    hideModal('fontSelectionModal');
                }
            });
        });


        /* Right sidebar action buttons */
        document.getElementById('deleteObjectBtn').addEventListener('click', deleteSelectedObject);
        document.getElementById('clearCanvasBtn').addEventListener('click', clearCanvas);
        document.getElementById('downloadBtn').addEventListener('click', downloadThumbnail);
        
        /* Floating controls action buttons */
        document.getElementById('undoBtn').addEventListener('click', undo);
        document.getElementById('redoBtn').addEventListener('click', redo);
        document.getElementById('bringForwardBtn').addEventListener('click', bringForward);
        document.getElementById('sendBackwardBtn').addEventListener('click', sendBackward);

        /* Zoom controls action buttons */
        document.getElementById('zoomInBtn').addEventListener('click', zoomIn);
        document.getElementById('zoomOutBtn').addEventListener('click', zoomOut);
        document.getElementById('resetZoomBtn').addEventListener('click', resetZoom);

        /* Lock Object Button */
        document.getElementById('lockObjectBtn').addEventListener('click', toggleLockObject);

        /* Color Overlay Modal for images */
        document.getElementById('overlayColorInput').addEventListener('input', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'image') {
                activeObject.set({ overlayColor: this.value });
                canvas.renderAll();
            }
        });
        document.getElementById('overlayOpacityRange').addEventListener('input', function() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'image') {
                activeObject.set({ overlayOpacity: parseFloat(this.value) });
                canvas.renderAll();
            }
        });
         document.querySelectorAll('#colorOverlayModal .color-option-box').forEach(box => {
            box.addEventListener('click', function() {
                const color = this.dataset.color;
                document.getElementById('overlayColorInput').value = color; // Update color input
                const activeObject = canvas.getActiveObject();
                 if (activeObject && activeObject.type === 'image') {
                    activeObject.set({ overlayColor: color });
                    canvas.renderAll();
                }
            });
        });


        /* --- Canvas Responsiveness and Initial Setup --- */
        function resizeCanvas() {
            const canvasArea = document.querySelector('.canvas-area');
            const availableWidth = canvasArea.offsetWidth - 20; /* Account for padding */
            const availableHeight = canvasArea.offsetHeight - 20;

            let newWidth, newHeight;
            const aspectRatio = 16 / 9;

            if (availableWidth / availableHeight > aspectRatio) {
                newHeight = availableHeight;
                newWidth = availableHeight * aspectRatio;
            } else {
                newWidth = availableWidth;
                newHeight = availableWidth / aspectRatio;
            }

            const canvasWrapper = document.querySelector('.canvas-wrapper');
            canvasWrapper.style.width = `${newWidth}px`;
            canvasWrapper.style.height = `${newHeight}px`;

            updateCanvasZoom(); 
        }

        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('orientationchange', resizeCanvas);
        resizeCanvas(); /* Initial resize on load */

    </script>
</body>
</html>
